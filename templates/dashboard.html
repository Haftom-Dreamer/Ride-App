<!-- dashboard.html -->
{% extends "base.html" %}

{% block title %}Dispatcher Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Dispatcher Dashboard</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">
            <!-- Pending Rides -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Pending Ride Requests</h2>
                <div id="pending-rides" class="space-y-4">
                    <p class="text-gray-500">No pending rides at the moment.</p>
                </div>
            </div>

            <!-- Assigned Rides -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Assigned Rides</h2>
                <div id="assigned-rides" class="space-y-4">
                     <p class="text-gray-500">No rides currently assigned.</p>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            <!-- Add New Driver -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Driver</h2>
                <form id="add-driver-form" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Driver Name</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                        <input type="text" id="phone" name="phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="vehicle" class="block text-sm font-medium text-gray-700">Vehicle Details</label>
                        <input type="text" id="vehicle" name="vehicle" required placeholder="e.g., Blue Toyota Corolla, #1234" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Add Driver</button>
                </form>
            </div>

            <!-- All Drivers List -->
            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">All Drivers</h2>
                <div id="all-drivers" class="space-y-2">
                    <p class="text-gray-500">No drivers added yet.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="error-message" class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg hidden"></div>
</div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:5000/api';
    const errorMessageDiv = document.getElementById('error-message');

    function showError(message) {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
    }

    async function fetchData(endpoint) {
        try {
            const url = `${API_BASE_URL}/${endpoint}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Network error: Status ${response.status}`);
            const textResponse = await response.text();
            try {
                return JSON.parse(textResponse);
            } catch (e) {
                console.error("Non-JSON response:", textResponse);
                throw new Error('Could not fetch data. Backend did not return valid JSON.');
            }
        } catch (error) {
            showError(error.message);
            return [];
        }
    }

    const renderPendingRides = (rides) => {
        const container = document.getElementById('pending-rides');
        if (!rides || rides.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No pending rides at the moment.</p>';
            return;
        }
        container.innerHTML = rides.map(ride => `
            <div class="bg-white p-4 rounded-lg shadow">
                <p><strong>Ride ID:</strong> ${ride.id} (${ride.vehicle_type})</p>
                <p><strong>To:</strong> ${ride.dest_address}</p>
                <p><strong>Fare:</strong> ${ride.fare} ETB</p>
                ${ride.note ? `<p class="mt-2 text-sm text-gray-600 bg-yellow-100 p-2 rounded"><strong>Note:</strong> ${ride.note}</p>` : ''}
                <div class="mt-2 flex items-center">
                    <label for="driver-select-${ride.id}" class="sr-only">Assign Driver</label>
                    <select id="driver-select-${ride.id}" class="rounded-md border-gray-300">
                        <option value="">Assign a driver...</option>
                    </select>
                    <button onclick="assignRide(${ride.id})" class="ml-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm">Assign</button>
                    <button onclick="cancelRide(${ride.id})" class="ml-2 px-3 py-1 bg-red-500 text-white rounded-md text-sm">Cancel</button>
                </div>
            </div>
        `).join('');
    };

    const renderAssignedRides = (rides) => {
        const container = document.getElementById('assigned-rides');
        if (!rides || rides.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No rides currently assigned.</p>';
            return;
        }
        container.innerHTML = rides.map(ride => `
            <div class="bg-white p-4 rounded-lg shadow">
                <p><strong>Ride ID:</strong> ${ride.id} -> <strong>Driver:</strong> ${ride.driver_name}</p>
                 <button onclick="completeRide(${ride.id})" class="mt-2 px-3 py-1 bg-green-500 text-white rounded-md text-sm">Mark as Complete</button>
            </div>
        `).join('');
    };

    const renderAllDrivers = (drivers) => {
        const container = document.getElementById('all-drivers');
        if (!drivers || drivers.length === 0) {
             container.innerHTML = '<p class="text-gray-500">No drivers added yet.</p>';
             return;
        }
        container.innerHTML = drivers.map(driver => `
            <div class="bg-white p-3 rounded-lg shadow flex justify-between items-center">
                <div>
                    <p class="font-semibold">${driver.name} - <span class="text-sm font-normal">${driver.status}</span></p>
                    <p class="text-xs text-gray-600">${driver.vehicle_details}</p>
                </div>
                <div>
                    <button onclick="updateDriverStatus(${driver.id}, 'Available')" class="px-2 py-1 bg-green-200 text-green-800 rounded-md text-xs">Available</button>
                    <button onclick="updateDriverStatus(${driver.id}, 'Offline')" class="ml-1 px-2 py-1 bg-red-200 text-red-800 rounded-md text-xs">Offline</button>
                </div>
            </div>
        `).join('');
    };

    const populateDriverDropdowns = async () => {
        const drivers = await fetchData('available-drivers');
        const selects = document.querySelectorAll('select[id^="driver-select-"]');
        selects.forEach(select => {
            select.innerHTML = '<option value="">Assign a driver...</option>';
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.name;
                select.appendChild(option);
            });
        });
    };
    
    const refreshData = async () => {
        errorMessageDiv.classList.add('hidden');
        const pendingRides = await fetchData('pending-rides');
        renderPendingRides(pendingRides);

        const assignedRides = await fetchData('assigned-rides');
        renderAssignedRides(assignedRides);

        const allDrivers = await fetchData('drivers');
        renderAllDrivers(allDrivers);

        await populateDriverDropdowns();
    };

    const assignRide = async (rideId) => {
        const driverId = document.getElementById(`driver-select-${rideId}`).value;
        if (!driverId) {
            alert('Please select a driver.');
            return;
        }
        await fetch(`${API_BASE_URL}/assign-ride`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ride_id: rideId, driver_id: driverId })
        });
        refreshData();
    };
    
    const completeRide = async (rideId) => {
        await fetch(`${API_BASE_URL}/complete-ride`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ride_id: rideId })
        });
        refreshData();
    };

    const cancelRide = async (rideId) => {
        if (!confirm('Are you sure you want to cancel this ride?')) return;
        await fetch(`${API_BASE_URL}/cancel-ride`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ride_id: rideId })
        });
        refreshData();
    };
    
    const updateDriverStatus = async (driverId, status) => {
        await fetch(`${API_BASE_URL}/update-driver-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ driver_id: driverId, status: status })
        });
        refreshData();
    };
    
    document.getElementById('add-driver-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const name = form.name.value;
        const phone = form.phone.value;
        const vehicle = form.vehicle.value;
        
        await fetch(`${API_BASE_URL}/add-driver`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, phone_number: phone, vehicle_details: vehicle })
        });
        form.reset();
        refreshData();
    });

    window.onload = () => {
        refreshData();
        setInterval(refreshData, 5000);
    };
</script>
{% endblock %}

