{% extends "base.html" %}

{% block title %}Advanced Dispatcher Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --sidebar-bg: #111827;
        --main-bg: #f3f4f6;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --card-bg: #ffffff;
        --border-color: #e5e7eb;
        --chart-green: #10b981;
        --chart-blue: #3b82f6;
        --chart-red: #ef4444;
        --chart-yellow: #f59e0b;
        --chart-purple: #8b5cf6;
        --chart-orange: #f97316;
    }

    .dark {
        --sidebar-bg: #030712;
        --main-bg: #111827;
        --text-primary: #f9fafb;
        --text-secondary: #9ca3af;
        --card-bg: #1f2937;
        --border-color: #4b5563;
    }

    body {
        background-color: var(--main-bg);
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        font-size: 14px;
    }

    .sidebar {
        background-color: var(--sidebar-bg);
    }

    .main-content {
        background-color: var(--main-bg);
    }

    .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #487098;
    }
    
    .dark .card {
        border-color: var(--border-color);
    }

    .sidebar-link {
        transition: all 0.2s ease-in-out;
    }

    .sidebar-link.active,
    .sidebar-link[aria-current="page"] {
        background-color: var(--chart-orange);
        color: white;
        font-weight: 600;
    }

    .sidebar-link:not(.active):hover {
        background-color: #374151;
    }

    .pane {
        display: none;
    }

    .pane.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn { from { opacity: 0.8; } to { opacity: 1; } }

    .modal {
        background-color: rgba(0, 0, 0, 0.6);
    }
    
    .modal-content {
        background-color: var(--card-bg);
        color: var(--text-primary);
    }

    .status-badge, .driver-status-select {
        padding: 4px 10px; border-radius: 6px; font-weight: 600;
        font-size: 11px; text-transform: uppercase; border: 1px solid transparent;
    }
    .status-Available, .status-select-Available { background-color: #dcfce7; color: #166534; border-color: #1665344d; }
    .status-On-Trip, .status-Assigned, .status-select-On-Trip { background-color: #ffedd5; color: #9a3412; border-color: #9a34124d; }
    .status-Offline, .status-select-Offline { background-color: #e5e7eb; color: #4b5563; border-color: #4b55634d; }
    .status-Requested { background-color: #dbeafe; color: #1e40af; }
    .status-Completed { background-color: #d1fae5; color: #065f46; }
    .status-Canceled { background-color: #fee2e2; color: #991b1b; }
    
    .action-btn { background: none; border: none; cursor: pointer; padding: 4px; transition: color 0.2s; }
    .action-btn.view:hover { color: #2563eb; }
    .action-btn.edit:hover { color: var(--chart-orange); }
    .action-btn.delete:hover { color: var(--chart-red); }
    
    .analytics-filter-btn.active-filter { background-color: #4f46e5; color: white; }

    .kpi-card {
        display: flex; flex-direction: column; justify-content: space-between;
        min-height: 120px; padding: 1.5rem;
    }
    .kpi-card .kpi-title { font-size: 0.875rem; color: var(--text-secondary); white-space: nowrap; }
    .kpi-card .kpi-value { font-size: 2.25rem; font-weight: 700; line-height: 1.1; }
    .kpi-card .kpi-trend { font-size: 0.8rem; font-weight: 600; padding: 2px 6px; border-radius: 99px; }
    .trend-up { background-color: #dcfce7; color: #166534; }
    .trend-down { background-color: #fee2e2; color: #991b1b; }
    
    .live-pulse { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

</style>
{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 font-sans">
    <!-- Sidebar -->
    <aside class="w-64 sidebar text-gray-300 flex flex-col flex-shrink-0">
        <div class="p-4 text-center border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white">Ride App</h1>
            <p class="text-xs text-gray-400">Dispatcher Panel</p>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg active" data-pane="dashboard"><svg
                    class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>Dashboard</a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-pane="analytics"><svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
              </svg>Analytics</a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-pane="live-map"><svg
                    class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>Live Map</a>
            <details class="group">
                <summary class="sidebar-link flex items-center p-3 rounded-lg cursor-pointer"><svg class="h-5 w-5 mr-3"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>Drivers<svg class="h-4 w-4 ml-auto transform group-open:rotate-90" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg></summary><a href="#"
                    class="sidebar-link flex items-center pl-11 pr-3 py-2 rounded-lg text-sm" data-pane="drivers">Driver
                    List</a>
            </details>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-pane="active-rides">
                <svg class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 003.375-3.375h1.5a1.125 1.125 0 011.125 1.125v-1.5a3.375 3.375 0 00-3.375-3.375H3.375m15.75 9.375v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 003.375-3.375h1.5c.621 0 1.125.504 1.125 1.125v16.5c0 .621-.504 1.125-1.125 1.125h-9.75" />
                </svg>Active Rides
            </a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-pane="rides"><svg
                    class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2 2h8a1 1 0 001-1zM3 11h10" />
                </svg>Ride History</a>
            <a href="#" class="sidebar-link flex items-center p-3 rounded-lg" data-pane="settings"><svg
                    class="h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>Settings</a>
        </nav>
        <div class="p-4 border-t border-gray-700 mt-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center"><img src="/static/img/default_avatar.png"
                        class="h-10 w-10 rounded-full object-cover" alt="Dispatcher">
                    <div class="ml-3">
                        <p class="text-sm font-semibold text-white">Dispatcher</p><a href="#"
                            class="text-xs text-red-400 hover:underline">Logout</a>
                    </div>
                </div><label for="dark-mode-toggle" class="cursor-pointer"><input type="checkbox" id="dark-mode-toggle"
                        class="hidden"><span id="dark-mode-icon">☀️</span></label>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-8 overflow-y-auto main-content">
        <div id="dashboard-pane" class="pane active">
            <h2 class="text-3xl font-bold text-primary mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 rounded-lg shadow">
                    <p class="text-sm text-secondary">Total Revenue</p>
                    <p id="stat-revenue" class="text-3xl font-bold text-green-500">0 ETB</p>
                </div>
                <div class="card p-6 rounded-lg shadow">
                    <p class="text-sm text-secondary">Total Rides</p>
                    <p id="stat-rides" class="text-3xl font-bold text-blue-500">0</p>
                </div>
                <div class="card p-6 rounded-lg shadow">
                    <p class="text-sm text-secondary">Drivers Online</p>
                    <p id="stat-drivers" class="text-3xl font-bold text-yellow-500">0</p>
                </div>
                <div class="card p-6 rounded-lg shadow">
                    <p class="text-sm text-secondary">Pending Requests</p>
                    <p id="stat-pending" class="text-3xl font-bold text-red-500">0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mb-8">
                <div class="lg:col-span-3 card p-6 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-primary">Live Ride Requests</h3>
                    <div id="dashboard-map" class="h-96 w-full rounded"></div>
                </div>
                <div class="lg:col-span-2 card p-6 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-primary">Pending Rides</h3>
                    <div id="pending-rides-list" class="space-y-3 overflow-y-auto h-96"></div>
                </div>
            </div>
        </div>
        
        <div id="analytics-pane" class="pane">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-primary">Data & Insights</h2>
                <button id="export-btn" class="px-4 py-2 text-sm font-semibold rounded-md bg-indigo-600 text-white">Export Report</button>
            </div>
            
            <div class="card p-4 rounded-lg shadow mb-6">
                <div id="analytics-filters" class="flex flex-wrap items-center gap-x-6 gap-y-2">
                    <h3 class="text-lg font-semibold text-primary">Filter by Date</h3>
                    <div class="flex items-center gap-2" id="analytics-period-btns">
                        <button data-period="today" class="analytics-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-200">Today</button>
                        <button data-period="week" class="analytics-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-200">This Week</button>
                        <button data-period="month" class="analytics-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-200">This Month</button>
                        <button data-period="all" class="analytics-filter-btn px-3 py-1.5 text-sm font-semibold rounded-md bg-gray-200">All Time</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="date" id="start-date-input" class="border p-1.5 rounded-md text-sm">
                        <span class="text-gray-500">to</span>
                        <input type="date" id="end-date-input" class="border p-1.5 rounded-md text-sm">
                        <button id="custom-range-btn" class="px-3 py-1.5 text-sm font-semibold rounded-md bg-indigo-600 text-white">Apply</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="kpi-card card rounded-lg shadow">
                    <p class="kpi-title">Rides Completed</p>
                    <p id="kpi-rides-completed" class="kpi-value" style="color: var(--chart-green);">0</p>
                    <div id="kpi-rides-trend" class="kpi-trend">--</div>
                </div>
                <div class="kpi-card card rounded-lg shadow">
                    <p class="kpi-title">Active Rides</p>
                    <p id="kpi-active-rides-now" class="kpi-value flex items-center" style="color: var(--chart-blue);">0 <span class="ml-2 w-3 h-3 bg-[--chart-blue] rounded-full live-pulse"></span></p>
                    <div class="kpi-trend opacity-0">--</div>
                </div>
                <div class="kpi-card card rounded-lg shadow">
                    <p class="kpi-title">Rides Canceled</p>
                    <p id="kpi-rides-canceled" class="kpi-value" style="color: var(--chart-red);">0</p>
                    <div class="kpi-trend opacity-0">--</div>
                </div>
                 <div class="kpi-card card rounded-lg shadow">
                    <p class="kpi-title">Total Revenue</p>
                    <p id="kpi-total-revenue" class="kpi-value" style="color: var(--chart-purple);">0</p>
                    <div id="kpi-revenue-trend" class="kpi-trend">--</div>
                </div>
                <div class="kpi-card card rounded-lg shadow">
                    <p class="kpi-title">Average Fare</p>
                    <p id="kpi-avg-fare" class="kpi-value" style="color: var(--chart-orange);">0</p>
                    <div class="kpi-trend opacity-0">--</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 card p-6 rounded-lg shadow">
                    <h3 class="font-semibold mb-4 text-primary">Revenue Over Time</h3>
                    <div class="relative h-96">
                        <canvas id="revenue-over-time-chart"></canvas>
                    </div>
                </div>
                <div class="space-y-8">
                    <div class="card p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-primary">Vehicle Distribution</h3>
                        <div class="relative h-40">
                            <canvas id="vehicle-dist-chart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4 text-primary">Payment Methods</h3>
                        <div class="relative h-40">
                            <canvas id="payment-dist-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card p-6 rounded-lg shadow mt-8">
                <h3 class="font-semibold text-primary mb-4">Top 5 Drivers This Week</h3>
                <div id="top-drivers-list" class="space-y-3"></div>
            </div>
        </div>

        <div id="active-rides-pane" class="pane">
            <h2 class="text-3xl font-bold text-primary mb-6">Active Rides Management</h2>
            <div class="card p-6 rounded-lg shadow">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="p-2">Passenger</th>
                            <th>Driver</th>
                            <th>Destination</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="active-rides-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="drivers-pane" class="pane">
            <h2 class="text-3xl font-bold text-primary mb-6">Driver Management</h2>
            <div class="card p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <input type="text" id="driver-search" placeholder="Search drivers..."
                        class="border p-2 rounded w-1/3">
                    <button id="add-driver-btn"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Add New
                        Driver</button>
                </div>
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="p-2">Name</th>
                            <th>Contact</th>
                            <th>Vehicle</th>
                            <th>Status</th>
                            <th>Rating</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="drivers-table-body"></tbody>
                </table>
            </div>
        </div>
        <div id="rides-pane" class="pane">
            <h2 class="text-3xl font-bold text-primary mb-6">Ride History</h2>
            <div class="card p-6 rounded-lg shadow">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="p-2">ID</th>
                            <th>Passenger</th>
                            <th>Driver</th>
                            <th>Fare</th>
                            <th>Status</th>
                            <th>Rating</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="rides-history-table-body"></tbody>
                </table>
            </div>
        </div>
        <div id="settings-pane" class="pane">
            <h2 class="text-3xl font-bold text-primary mb-6">Settings</h2>
            <div class="card p-6 rounded-lg shadow max-w-lg">
                <h3 class="text-xl font-semibold mb-4 text-primary">Fare Configuration</h3>
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label for="base-fare" class="block">Base Fare (ETB)</label>
                        <input type="number" step="any" name="base_fare" class="border p-2 rounded-md w-full">
                    </div>
                    <div>
                        <label for="per-km-bajaj" class="block">Per/KM Rate - Bajaj (ETB)</label>
                        <input type="number" step="any" name="per_km_bajaj" class="border p-2 rounded-md w-full">
                    </div>
                    <div>
                        <label for="per-km-car" class="block">Per/KM Rate - Car (ETB)</label>
                        <input type="number" step="any" name="per_km_car" class="border p-2 rounded-md w-full">
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save Settings</button>
                </form>
            </div>
        </div>
    </main>
</div>

<!-- Modals -->
<div id="export-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="modal-content p-8 rounded-lg shadow-xl z-10 w-full max-w-sm text-center">
        <h2 class="text-xl font-bold mb-4">Export Analytics Report</h2>
        <p class="text-secondary mb-6">Choose a format to download your report for the currently selected date range.</p>
        <div class="flex justify-center space-x-4">
            <button id="export-pdf-btn" class="flex-1 px-4 py-2 text-sm font-semibold rounded-md bg-red-600 text-white">Download PDF</button>
            <button id="export-excel-btn" class="flex-1 px-4 py-2 text-sm font-semibold rounded-md bg-green-600 text-white">Download Excel</button>
        </div>
        <button type="button" class="cancel-modal-btn mt-6 text-sm text-secondary hover:underline">Cancel</button>
    </div>
</div>

<div id="add-driver-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="modal-content p-8 rounded-lg shadow-xl z-10 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Add New Driver</h2>
        <form id="add-driver-form" enctype="multipart/form-data">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium">Name</label><input type="text" name="name" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Phone</label><input type="text" name="phone_number" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div>
                    <label class="block text-sm font-medium">Vehicle Type</label>
                    <select name="vehicle_type" required class="mt-1 block w-full p-2 border rounded-md">
                        <option value="Bajaj">Bajaj</option>
                        <option value="Car">Car</option>
                        <option value="Minibus">Minibus</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium">Vehicle Details (e.g., Blue Bajaj)</label><input type="text" name="vehicle_details" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Plate Number</label><input type="text" name="vehicle_plate_number" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">License Info</label><input type="text" name="license_info" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Profile Picture (Optional)</label><input type="file" name="profile_picture" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*"></div>
                <div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-200 rounded-lg">Cancel</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save</button></div>
            </div>
        </form>
    </div>
</div>

<div id="edit-driver-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="modal-content p-8 rounded-lg shadow-xl z-10 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">Edit Driver</h2>
        <form id="edit-driver-form" enctype="multipart/form-data">
            <input type="hidden" name="id">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium">Name</label><input type="text" name="name" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Phone</label><input type="text" name="phone_number" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div>
                    <label class="block text-sm font-medium">Vehicle Type</label>
                    <select name="vehicle_type" required class="mt-1 block w-full p-2 border rounded-md">
                        <option value="Bajaj">Bajaj</option>
                        <option value="Car">Car</option>
                        <option value="Minibus">Minibus</option>
                    </select>
                </div>
                <div><label class="block text-sm font-medium">Vehicle Details</label><input type="text" name="vehicle_details" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">Plate Number</label><input type="text" name="vehicle_plate_number" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">License Info</label><input type="text" name="license_info" required class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label class="block text-sm font-medium">New Profile Picture (Optional)</label><input type="file" name="profile_picture" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*"></div>
                <div class="flex justify-end space-x-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-200 rounded-lg">Cancel</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save Changes</button></div>
            </div>
        </form>
    </div>
</div>

<div id="delete-driver-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="modal-content p-8 rounded-lg shadow-xl z-10 w-full max-w-sm text-center">
        <h2 class="text-xl font-bold mb-2">Are you sure?</h2>
        <p class="text-secondary mb-6">This will permanently delete the driver. This action cannot be undone.</p>
        <div class="flex justify-center space-x-4">
            <button type="button" class="cancel-modal-btn px-6 py-2 bg-gray-200 rounded-lg">Cancel</button>
            <button id="confirm-delete-btn" type="button" class="px-6 py-2 bg-red-600 text-white rounded-lg">Delete</button>
        </div>
    </div>
</div>

<div id="driver-details-modal" class="modal fixed inset-0 z-50 items-center justify-center hidden">
    <div class="absolute inset-0 bg-black opacity-50"></div>
    <div class="modal-content p-8 rounded-lg shadow-xl z-10 w-full max-w-2xl">
        <h2 class="text-2xl font-bold mb-4">Driver Details</h2>
        <div id="driver-details-content"></div>
        <div class="flex justify-end mt-4"><button type="button" class="cancel-modal-btn px-4 py-2 bg-gray-200 rounded-lg">Close</button></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONFIG ---
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        let dashboardMap, revenueChart, vehicleDistChart, paymentDistChart;
        let pendingRideMarkers = {}, routeLayers = {};
        let currentAnalyticsParams = 'period=week'; // Default filter
        
        const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        const chartTextColor = () => getCssVar('--text-primary');

        let highlightedIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        let defaultIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // --- ELEMENT SELECTORS ---
        const panes = document.querySelectorAll('.pane');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const modals = document.querySelectorAll('.modal');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeIcon = document.getElementById('dark-mode-icon');
        const driversTableBody = document.getElementById('drivers-table-body');
        const activeRidesTableBody = document.getElementById('active-rides-table-body');
        const pendingRidesList = document.getElementById('pending-rides-list');

        // --- HELPER FUNCTIONS ---
        const fetchData = async (endpoint, params = '') => {
            try {
                const r = await fetch(`${API_BASE_URL}/${endpoint}?${params}`, { cache: "no-store" });
                if (!r.ok) throw new Error(`HTTP error ${r.status}`);
                return await r.json();
            } catch (e) { console.error(`Fetch error for ${endpoint}:`, e); return null; }
        };
        const postData = async (endpoint, data) => {
            try {
                const r = await fetch(`${API_BASE_URL}/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!r.ok) throw new Error(`HTTP error ${r.status}`);
                return await r.json();
            } catch (e) { console.error(`Post error for ${endpoint}:`, e); return null; }
        };
        const postFormData = async (endpoint, formData) => {
            try {
                const r = await fetch(`${API_BASE_URL}/${endpoint}`, { method: 'POST', body: formData });
                if (!r.ok) throw new Error(`HTTP error ${r.status}`);
                return await r.json();
            } catch (e) { console.error(`Post Form error for ${endpoint}:`, e); return null; }
        };

        const showModal = (id) => { hideModals(); document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); }
        const hideModals = () => modals.forEach(m => { m.classList.add('hidden'); m.classList.remove('flex'); });

        const formatLargeNumber = (num) => {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num;
        };

        // --- UI & NAVIGATION ---
        const showPane = (paneId) => {
            panes.forEach(p => p.classList.remove('active'));
            const targetPane = document.getElementById(`${paneId}-pane`);
            if (targetPane) targetPane.classList.add('active');
            
            document.querySelectorAll('.sidebar-link[data-pane]').forEach(l => l.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[data-pane="${paneId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                const details = activeLink.closest('details');
                if (details) details.open = true;
            }
            if (paneId === 'dashboard' && !dashboardMap) initDashboardMap();
            if (paneId === 'analytics') updateAnalytics();
            if (dashboardMap) setTimeout(() => dashboardMap.invalidateSize(), 10);
        };
        sidebarLinks.forEach(link => { if (link.dataset.pane) { link.addEventListener('click', e => { e.preventDefault(); showPane(link.dataset.pane); }); } });

        // --- DARK MODE ---
        const setDarkMode = (isDark) => { 
            if (isDark) { document.documentElement.classList.add('dark'); darkModeIcon.textContent = '🌙'; } 
            else { document.documentElement.classList.remove('dark'); darkModeIcon.textContent = '☀️'; } 
            localStorage.setItem('darkMode', isDark); 
            // Update chart colors on theme change
            if (document.getElementById('analytics-pane').classList.contains('active')) {
                updateAnalytics();
            }
        };
        darkModeToggle.addEventListener('change', (e) => setDarkMode(e.target.checked));
        if (localStorage.getItem('darkMode') === 'true') { darkModeToggle.checked = true; setDarkMode(true); }

        // --- MODAL LOGIC ---
        document.getElementById('add-driver-btn').addEventListener('click', () => showModal('add-driver-modal'));
        document.getElementById('export-btn').addEventListener('click', () => showModal('export-modal'));
        modals.forEach(modal => modal.addEventListener('click', e => { if (e.target.classList.contains('modal') || e.target.classList.contains('cancel-modal-btn')) hideModals(); }));
        document.getElementById('add-driver-form').addEventListener('submit', async e => { e.preventDefault(); await postFormData('add-driver', new FormData(e.target)); hideModals(); e.target.reset(); refreshAllData(); });
        document.getElementById('edit-driver-form').addEventListener('submit', async e => { e.preventDefault(); const formData = new FormData(e.target); await postFormData(`update-driver/${formData.get('id')}`, formData); hideModals(); refreshAllData(); });
        document.getElementById('confirm-delete-btn').addEventListener('click', async e => { await postData('delete-driver', { driver_id: e.target.dataset.driverId }); hideModals(); refreshAllData(); });
        
        // --- EXPORT LOGIC ---
        document.getElementById('export-pdf-btn').addEventListener('click', () => { window.location.href = `${API_BASE_URL}/export-report?format=pdf&${currentAnalyticsParams}`; hideModals(); });
        document.getElementById('export-excel-btn').addEventListener('click', () => { window.location.href = `${API_BASE_URL}/export-report?format=excel&${currentAnalyticsParams}`; hideModals(); });

        // --- ANALYTICS LOGIC ---
        const setAnalyticsFilter = (params) => { currentAnalyticsParams = params; updateAnalytics(); };

        document.getElementById('analytics-period-btns').addEventListener('click', e => {
            if (e.target.matches('.analytics-filter-btn')) {
                document.querySelectorAll('.analytics-filter-btn').forEach(btn => btn.classList.remove('active-filter'));
                e.target.classList.add('active-filter');
                document.getElementById('start-date-input').value = '';
                document.getElementById('end-date-input').value = '';
                setAnalyticsFilter(`period=${e.target.dataset.period}`);
            }
        });
        document.getElementById('custom-range-btn').addEventListener('click', () => {
            const start = document.getElementById('start-date-input').value;
            const end = document.getElementById('end-date-input').value;
            if (start && end) { document.querySelectorAll('.analytics-filter-btn').forEach(btn => btn.classList.remove('active-filter')); setAnalyticsFilter(`start_date=${start}&end_date=${end}`); }
        });

        // --- DATA RENDERING ---
        const updateDashboardStats = stats => { if (stats) { ['total_revenue', 'total_rides', 'drivers_online', 'pending_requests'].forEach(key => { const el = document.getElementById(`stat-${key.split('_')[0]}`); if(el) el.textContent = `${stats[key]}` + (key === 'total_revenue' ? ' ETB' : ''); }); } };

        const updateAnalyticsKPIs = (kpis) => {
            if(!kpis) return;
            document.getElementById('kpi-rides-completed').textContent = formatLargeNumber(kpis.rides_completed);
            document.getElementById('kpi-active-rides-now').textContent = kpis.active_rides_now;
            document.getElementById('kpi-rides-canceled').textContent = kpis.rides_canceled;
            document.getElementById('kpi-total-revenue').textContent = `${formatLargeNumber(kpis.total_revenue)}`;
            document.getElementById('kpi-avg-fare').textContent = `${kpis.avg_fare.toFixed(2)}`;

            const updateTrend = (elId, trendVal) => {
                const el = document.getElementById(elId);
                el.textContent = `${trendVal >= 0 ? '↑' : '↓'} ${Math.abs(trendVal)}%`;
                el.className = `kpi-trend ${trendVal >= 0 ? 'trend-up' : 'trend-down'}`;
            };
            updateTrend('kpi-rides-trend', kpis.trends.rides);
            updateTrend('kpi-revenue-trend', kpis.trends.revenue);
        };
        const updateAnalyticsCharts = (charts) => {
            if(!charts) return;
            const createChart = (ctxId, chartVar, type, data, options) => {
                const ctx = document.getElementById(ctxId).getContext('2d');
                if(window[chartVar]) window[chartVar].destroy();
                window[chartVar] = new Chart(ctx, { type, data, options });
            };

            const commonOptions = { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { labels: { color: chartTextColor() } } }
            };

            createChart('revenue-over-time-chart', 'revenueChart', 'bar', {
                labels: charts.revenue_over_time.labels,
                datasets: [{ label: 'Daily Revenue (ETB)', data: charts.revenue_over_time.data, backgroundColor: getCssVar('--chart-purple') }]
            }, { ...commonOptions, scales: { y: { beginAtZero: true, ticks: { color: chartTextColor() } }, x: { ticks: { color: chartTextColor() } } } });
            
            createChart('vehicle-dist-chart', 'vehicleDistChart', 'doughnut', {
                labels: Object.keys(charts.vehicle_distribution),
                datasets: [{ data: Object.values(charts.vehicle_distribution), backgroundColor: [getCssVar('--chart-orange'), getCssVar('--chart-blue')] }]
            }, commonOptions);

            createChart('payment-dist-chart', 'paymentDistChart', 'doughnut', {
                labels: Object.keys(charts.payment_method_distribution),
                datasets: [{ data: Object.values(charts.payment_method_distribution), backgroundColor: [getCssVar('--chart-green'), getCssVar('--chart-yellow')] }]
            }, commonOptions);
        };
        const updateTopDrivers = (drivers) => {
            const list = document.getElementById('top-drivers-list');
            list.innerHTML = '';
            if (!drivers || drivers.length === 0) {
                list.innerHTML = '<p class="text-sm text-secondary">No driver data for this week yet.</p>';
                return;
            }
            drivers.forEach(d => {
                const driverEl = document.createElement('div');
                driverEl.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800';
                driverEl.innerHTML = `
                    <div class="flex items-center">
                        <img src="/${d.avatar}" class="h-10 w-10 rounded-full object-cover mr-4" onerror="this.src='/static/img/default_avatar.png'">
                        <div>
                            <p class="font-semibold">${d.name}</p>
                            <p class="text-xs text-secondary">${d.avg_rating} ★ Rating</p>
                        </div>
                    </div>
                    <p class="font-bold text-lg text-[--chart-blue]">${d.completed_rides} <span class="text-sm font-normal text-secondary">rides</span></p>
                `;
                list.appendChild(driverEl);
            });
        };

        const updatePendingRides = (rides, drivers) => {
            pendingRidesList.innerHTML = '';
            Object.values(pendingRideMarkers).forEach(m => { if (dashboardMap?.hasLayer(m)) dashboardMap.removeLayer(m); });
            Object.values(routeLayers).forEach(l => { if (dashboardMap?.hasLayer(l)) dashboardMap.removeLayer(l); });
            pendingRideMarkers = {}; routeLayers = {};
            
            if (!rides || rides.length === 0) { pendingRidesList.innerHTML = `<p class="text-gray-500 text-sm p-4">No pending rides.</p>`; return; }
            
            rides.forEach(ride => {
                if (dashboardMap) {
                    pendingRideMarkers[ride.id] = L.marker([ride.pickup_lat, ride.pickup_lon], {icon: defaultIcon}).addTo(dashboardMap)
                        .bindPopup(`<b>Request #${ride.id}</b><br/>From: ${ride.pickup_address || 'N/A'}<br/>To: ${ride.dest_address}`);

                    if(ride.dest_lat && ride.dest_lon) {
                        pendingRideMarkers[`dest_${ride.id}`] = L.marker([ride.dest_lat, ride.dest_lon], { icon: L.icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(dashboardMap).bindPopup("Destination");
                        drawRouteOnMap({lat: ride.pickup_lat, lon: ride.pickup_lon}, {lat: ride.dest_lat, lon: ride.dest_lon}, ride.id);
                    }
                }
                const rideEl = document.createElement('div');
                rideEl.className = 'border-b border-[--border-color] pb-3 p-3 rounded-md hover:bg-[--main-bg] cursor-pointer transition-colors';
                rideEl.dataset.rideId = ride.id;

                const filteredDrivers = drivers.filter(d => d.vehicle_type === ride.vehicle_type && d.status === 'Available');
                const driverOptions = filteredDrivers.length > 0 ? filteredDrivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('') : '<option disabled>No available drivers</option>';

                rideEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-sm">${ride.user_name} <span class="font-normal text-xs text-secondary">(${ride.user_phone})</span></p>
                        <span class="font-bold text-sm text-[--chart-purple]">${ride.vehicle_type}</span>
                    </div>
                    <div class="mt-2 text-xs space-y-1 text-secondary">
                        <p><span class="font-semibold text-[--text-primary]">From:</span> ${ride.pickup_address || 'N/A'}</p>
                        <p><span class="font-semibold text-[--text-primary]">To:</span> ${ride.dest_address}</p>
                        <p class="text-xs text-indigo-600 font-medium">Note: ${ride.note || 'None'}</p>
                    </div>
                    <div class="mt-2 flex items-center">
                        <select id="driver-select-${ride.id}" class="p-1 border rounded text-xs w-full">${driverOptions}</select>
                        <button class="assign-ride-btn ml-2 px-3 py-1 bg-blue-500 text-white text-xs rounded" data-ride-id="${ride.id}" ${filteredDrivers.length === 0 ? 'disabled' : ''}>Assign</button>
                    </div>`;
                pendingRidesList.appendChild(rideEl);
            });
        };
        const updateDriversTable = (drivers) => {
            driversTableBody.innerHTML = '';
            if (!drivers || drivers.length === 0) return;
            drivers.forEach(driver => {
                const statusOptions = ['Available', 'On Trip', 'Offline'].map(s => `<option value="${s}" ${driver.status === s ? 'selected' : ''}>${s}</option>`).join('');
                const row = driversTableBody.insertRow();
                const avgRating = driver.avg_rating ? `${driver.avg_rating.toFixed(1)} ★` : 'N/A';
                row.innerHTML = `
                    <td class="p-2 flex items-center"><img src="/${driver.profile_picture}" class="h-8 w-8 rounded-full mr-3 object-cover" alt="Driver" onerror="this.src='/static/img/default_avatar.png'">${driver.name}</td>
                    <td>${driver.phone_number}</td>
                    <td>${driver.vehicle_type}</td>
                    <td><select class="driver-status-select" data-driver-id="${driver.id}">${statusOptions}</select></td>
                    <td>${avgRating}</td>
                    <td class="text-lg space-x-2">
                        <button class="action-btn view" data-driver-id="${driver.id}" title="View Details">👁️</button>
                        <button class="action-btn edit" data-driver-id="${driver.id}" title="Edit Driver">✏️</button>
                        <button class="action-btn delete" data-driver-id="${driver.id}" title="Delete Driver">🗑️</button>
                    </td>`;
                const select = row.querySelector('.driver-status-select');
                const updateColor = () => { select.className = 'driver-status-select status-select-' + select.value.replace(' ', '-'); };
                select.addEventListener('change', updateColor);
                updateColor();
            });
        };
        const updateActiveRidesTable = (rides) => {
            activeRidesTableBody.innerHTML = '';
            if (!rides || rides.length === 0) { activeRidesTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No active rides</td></tr>'; return; }
            rides.forEach(ride => {
                const row = activeRidesTableBody.insertRow();
                row.innerHTML = `
                    <td class="p-2">${ride.user_name}</td>
                    <td>${ride.driver_name}</td>
                    <td class="text-xs max-w-xs truncate">${ride.dest_address}</td>
                    <td><span class="status-badge status-${ride.status.replace(' ', '-')}">${ride.status}</span></td>
                    <td class="space-x-2">
                        <button class="px-3 py-1 bg-green-500 text-white text-xs rounded complete-ride-btn" data-ride-id="${ride.id}">Complete</button>
                        <button class="px-3 py-1 bg-yellow-500 text-white text-xs rounded reassign-ride-btn" data-ride-id="${ride.id}">Re-assign</button>
                    </td>`;
            });
        };
        const updateRideHistoryTable = (rides) => {
            const tableBody = document.getElementById('rides-history-table-body');
            tableBody.innerHTML = '';
            if (!rides || rides.length === 0) return;
            rides.forEach(ride => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="p-2">${ride.id}</td><td>${ride.user_name}</td><td>${ride.driver_name}</td><td>${ride.fare} ETB</td><td><span class="status-badge status-${ride.status}">${ride.status}</span></td><td>${ride.rating ? '★'.repeat(ride.rating) : 'N/A'}</td><td>${ride.request_time}</td>`;
            });
        };

        // --- EVENT LISTENERS ---
        pendingRidesList.addEventListener('click', async (e) => { 
            if (e.target.classList.contains('assign-ride-btn')) { 
                const rideId = e.target.dataset.rideId; 
                const driverId = document.getElementById(`driver-select-${rideId}`).value; 
                if (driverId) await postData('assign-ride', { ride_id: rideId, driver_id: driverId }); 
                else alert('Please select a driver.'); 
                refreshAllData(); 
            }
        });
        pendingRidesList.addEventListener('mouseover', e => {
            const rideItem = e.target.closest('[data-ride-id]');
            if (rideItem) {
                const rideId = rideItem.dataset.rideId;
                const marker = pendingRideMarkers[rideId];
                if (marker) {
                    marker.setIcon(highlightedIcon);
                    marker.setZIndexOffset(1000);
                }
            }
        });
        pendingRidesList.addEventListener('mouseout', e => {
            const rideItem = e.target.closest('[data-ride-id]');
            if (rideItem) {
                const rideId = rideItem.dataset.rideId;
                const marker = pendingRideMarkers[rideId];
                if (marker) {
                    marker.setIcon(defaultIcon);
                    marker.setZIndexOffset(0);
                }
            }
        });
        driversTableBody.addEventListener('change', async (e) => { if (e.target.classList.contains('driver-status-select')) { await postData('update-driver-status', { driver_id: e.target.dataset.driverId, status: e.target.value }); refreshAllData(); } });
        driversTableBody.addEventListener('click', async (e) => {
            const button = e.target.closest('.action-btn');
            if (!button) return;
            const driverId = button.dataset.driverId;
            if (button.classList.contains('view')) { 
                const data = await fetchData(`driver-details/${driverId}`); 
                if (data) showDriverDetails(data); 
            } else if (button.classList.contains('edit')) { 
                const driver = await fetchData(`driver/${driverId}`); 
                if (driver) { 
                    const form = document.getElementById('edit-driver-form');
                    form.reset();
                    form.elements.id.value = driver.id;
                    form.elements.name.value = driver.name;
                    form.elements.phone_number.value = driver.phone_number;
                    form.elements.vehicle_type.value = driver.vehicle_type;
                    form.elements.vehicle_details.value = driver.vehicle_details;
                    form.elements.vehicle_plate_number.value = driver.vehicle_plate_number;
                    form.elements.license_info.value = driver.license_info;
                    showModal('edit-driver-modal');
                }
            } else if (button.classList.contains('delete')) { 
                document.getElementById('confirm-delete-btn').dataset.driverId = driverId; 
                showModal('delete-driver-modal'); 
            }
        });
        activeRidesTableBody.addEventListener('click', async (e) => { 
            const rideId = e.target.dataset.rideId; 
            if (!rideId) return; 
            if (e.target.classList.contains('complete-ride-btn')) await postData('complete-ride', { ride_id: rideId }); 
            else if (e.target.classList.contains('reassign-ride-btn')) await postData('cancel-ride', { ride_id: rideId }); 
            refreshAllData(); 
        });
        document.getElementById('settings-form').addEventListener('submit', async (e) => { e.preventDefault(); await postData('settings', Object.fromEntries(new FormData(e.target).entries())); alert('Settings Saved!'); });

        // --- DRIVER DETAILS LOGIC ---
        const showDriverDetails = (data) => {
            const content = document.getElementById('driver-details-content');
            const avatarSrc = `/${data.profile.avatar}`;
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 text-center">
                        <img src="${avatarSrc}" class="rounded-full w-32 h-32 mx-auto object-cover border-4 border-gray-200" onerror="this.src='/static/img/default_avatar.png'">
                        <h3 class="text-xl font-bold mt-4">${data.profile.name}</h3>
                        <p class="text-sm text-secondary">${data.profile.phone_number}</p>
                        <span class="status-badge status-${data.profile.status.replace(' ', '-')} mt-2 inline-block">${data.profile.status}</span>
                    </div>
                    <div class="md:col-span-2 space-y-4">
                        <div>
                            <h4 class="font-bold text-lg">Vehicle Information</h4>
                            <div class="text-sm space-y-1 mt-2 text-secondary">
                                <p><strong>Type:</strong> ${data.profile.vehicle_type}</p>
                                <p><strong>Details:</strong> ${data.profile.vehicle_details}</p>
                                <p><strong>Plate #:</strong> ${data.profile.plate_number}</p>
                                <p><strong>License:</strong> ${data.profile.license}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg">Performance Metrics</h4>
                            <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                                <div class="card p-3 rounded-md"><p class="font-semibold text-secondary">Completed Rides</p><p class="text-2xl font-bold">${data.stats.completed_rides}</p></div>
                                <div class="card p-3 rounded-md"><p class="font-semibold text-secondary">Avg. Rating</p><p class="text-2xl font-bold">${data.stats.avg_rating} ★</p></div>
                                <div class="card p-3 rounded-md"><p class="font-semibold text-secondary">Weekly Earnings</p><p class="text-2xl font-bold">${data.stats.total_earnings} ETB</p></div>
                                <div class="card p-3 rounded-md"><p class="font-semibold text-secondary">Avg. Response Time</p><p class="text-2xl font-bold">${data.stats.avg_assignment_time}</p></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            showModal('driver-details-modal');
        };

        async function drawRouteOnMap(pickup, destination, rideId) {
            const url = `https://router.project-osrm.org/route/v1/driving/${pickup.lon},${pickup.lat};${destination.lon},${destination.lat}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    routeLayers[rideId] = L.polyline(routeCoords, { color: getCssVar('--chart-purple'), weight: 5 }).addTo(dashboardMap);
                }
            } catch (error) { console.error('Error fetching route:', error); }
        }

        const updateAnalytics = async () => {
            const data = await fetchData('analytics-data', currentAnalyticsParams);
            if (data) {
                updateAnalyticsKPIs(data.kpis);
                updateAnalyticsCharts(data.charts);
                updateTopDrivers(data.performance.top_drivers);
            }
        };

        const refreshDashboardData = async () => {
             const [stats, pendingRides, availableDrivers, activeRides] = await Promise.all([
                fetchData('dashboard-stats'), 
                fetchData('pending-rides'), 
                fetchData('available-drivers'), 
                fetchData('active-rides')
            ]);
            updateDashboardStats(stats || {});
            updatePendingRides(pendingRides || [], availableDrivers || []);
            updateActiveRidesTable(activeRides || []);
        };

        const refreshAllData = async () => {
            const [drivers, ridesHistory, settings] = await Promise.all([
                fetchData('drivers'), 
                fetchData('all-rides-data'), 
                fetchData('settings')
            ]);
             updateDriversTable(drivers || []);
             updateRideHistoryTable(ridesHistory || []);
             if (settings) {
                const form = document.getElementById('settings-form');
                form.base_fare.value = settings.base_fare || 25;
                form.per_km_bajaj.value = settings.per_km_bajaj || 8;
                form.per_km_car.value = settings.per_km_car || 12;
            }
            refreshDashboardData();
        };

        // --- INITIALIZATION ---
        const initDashboardMap = () => { if (!dashboardMap) { dashboardMap = L.map('dashboard-map').setView([14.275, 39.46], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(dashboardMap); } }
        
        document.querySelector('.analytics-filter-btn[data-period="week"]').classList.add('active-filter');

        showPane('dashboard');
        refreshAllData();
        setInterval(refreshDashboardData, 10000);
    });
</script>
{% endblock %}

