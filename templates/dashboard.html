{% extends "base.html" %}

{% block title %}Dispatcher Dashboard{% endblock %}

{% block head %}
    <style>
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow-x: hidden;
            overflow-y: hidden;
        }
    </style>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-6">Ride Dispatcher Dashboard</h1>

<!-- Main layout with two columns -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Left Column: Ride and Driver Lists -->
    <div class="lg:col-span-2 space-y-8">
        <!-- Rides Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Live Rides</h2>
                <button id="refresh-all-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Refresh All
                </button>
            </div>
            <!-- Sub-section for Pending Rides -->
            <div>
                <h3 class="text-lg font-semibold text-gray-600 mb-2 border-b pb-2">Pending Requests</h3>
                <div id="pending-rides-list" class="space-y-4">
                    <p class="text-gray-500">Click "Refresh" to load rides...</p>
                </div>
            </div>
             <!-- Sub-section for Assigned Rides -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold text-gray-600 mb-2 border-b pb-2">Assigned (On Trip)</h3>
                <div id="assigned-rides-list" class="space-y-4">
                    <p class="text-gray-500">Assigned rides will appear here.</p>
                </div>
            </div>
        </div>

        <!-- All Drivers Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">All Drivers</h2>
            <div id="all-drivers-list" class="space-y-3">
                <p class="text-gray-500">Your drivers will be listed here.</p>
            </div>
        </div>
    </div>

    <!-- Right Column: Driver Management -->
    <div class="space-y-8">
        <!-- Available Drivers Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Available Drivers</h2>
            <div id="available-drivers-list" class="space-y-3">
                 <p class="text-gray-500">Drivers will appear here when their status is "Available".</p>
            </div>
        </div>

        <!-- Add New Driver Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Driver</h2>
            <div class="space-y-4">
                <div>
                    <label for="driver-name" class="block text-sm font-medium text-gray-700">Driver Name</label>
                    <input type="text" id="driver-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., John Doe">
                </div>
                <div>
                    <label for="driver-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                    <input type="tel" id="driver-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0912345678">
                </div>
                <div>
                    <label for="vehicle-details" class="block text-sm font-medium text-gray-700">Vehicle Details</label>
                    <input type="text" id="vehicle-details" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., Blue Toyota Vitz, #A12345">
                </div>
                <button id="add-driver-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Save Driver
                </button>
                <p id="add-driver-status" class="text-sm text-center mt-2"></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Assigning a Driver (No changes here) -->
<div id="assign-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-y-auto">
        <div class="modal-content py-4 text-left px-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold">Assign Driver</p>
                <button class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18"><path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path></svg>
                </button>
            </div>
            <p class="mb-4">Select an available driver to assign to Ride #<span id="modal-ride-id" class="font-bold"></span>.</p>
            <select id="driver-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            <div class="flex justify-end pt-4">
                <button class="modal-close px-4 bg-transparent p-3 rounded-lg text-indigo-500 hover:bg-gray-100 hover:text-indigo-400 mr-2">Cancel</button>
                <button id="confirm-assign-btn" class="px-4 bg-blue-500 p-3 rounded-lg text-white hover:bg-blue-600">Confirm Assignment</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://127.0.0.1:5000';

    // --- Element Selectors ---
    const refreshButton = document.getElementById('refresh-all-btn');
    const ridesList = document.getElementById('pending-rides-list');
    const assignedRidesList = document.getElementById('assigned-rides-list');
    const availableDriversList = document.getElementById('available-drivers-list');
    const allDriversList = document.getElementById('all-drivers-list');
    
    // Add Driver Form Elements
    const addDriverBtn = document.getElementById('add-driver-btn');
    const driverNameInput = document.getElementById('driver-name');
    const driverPhoneInput = document.getElementById('driver-phone');
    const vehicleDetailsInput = document.getElementById('vehicle-details');
    const addDriverStatus = document.getElementById('add-driver-status');

    // Modal Elements
    const modal = document.getElementById('assign-modal');
    const modalRideIdSpan = document.getElementById('modal-ride-id');
    const driverSelect = document.getElementById('driver-select');
    const confirmAssignBtn = document.getElementById('confirm-assign-btn');
    let selectedRideId = null;

    // --- Main Data Fetching Function ---
    function refreshAllData() {
        fetchPendingRides();
        fetchAssignedRides();
        fetchAvailableDrivers();
        fetchAllDrivers();
    }

    // --- Generic Fetch Function with Error Handling ---
    async function fetchData(url, element) {
        try {
            const response = await fetch(url);
            const contentType = response.headers.get("content-type");
            if (!response.ok || !contentType || !contentType.includes("application/json")) {
                throw new Error('Backend did not return valid JSON. Is the server running correctly?');
            }
            return await response.json();
        } catch (error) {
            element.innerHTML = `<p class="text-red-500 font-semibold">Error: Could not fetch data.</p><p class="text-red-400 text-sm">${error.message}</p>`;
            return null;
        }
    }


    // --- Fetch Functions ---
    async function fetchPendingRides() {
        const data = await fetchData(`${API_BASE_URL}/api/rides/pending`, ridesList);
        if (!data) return;

        ridesList.innerHTML = '';
        if (data.pending_rides.length === 0) {
            ridesList.innerHTML = '<p class="text-gray-500">No pending rides found.</p>';
        } else {
            data.pending_rides.forEach(ride => {
                const rideElement = document.createElement('div');
                rideElement.className = 'border p-4 rounded-lg bg-gray-50';
                rideElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg">Ride #${ride.ride_id} - ${ride.user_name}</p>
                            <p class="text-sm text-gray-600">To: ${ride.dest_address}</p>
                        </div>
                        <button onclick="openAssignModal(${ride.ride_id})" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm">Assign</button>
                    </div>`;
                ridesList.appendChild(rideElement);
            });
        }
    }

    async function fetchAssignedRides() {
        const data = await fetchData(`${API_BASE_URL}/api/rides/assigned`, assignedRidesList);
        if (!data) return;

        assignedRidesList.innerHTML = '';
        if (data.assigned_rides.length === 0) {
            assignedRidesList.innerHTML = '<p class="text-gray-500">No rides currently assigned.</p>';
        } else {
            data.assigned_rides.forEach(ride => {
                const rideElement = document.createElement('div');
                rideElement.className = 'border p-4 rounded-lg bg-yellow-50';
                rideElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg">Ride #${ride.ride_id} - ${ride.user_name}</p>
                            <p class="text-sm text-gray-600">Driver: ${ride.driver_name}</p>
                        </div>
                        <button onclick="completeRide(${ride.ride_id})" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg text-sm">Complete</button>
                    </div>`;
                assignedRidesList.appendChild(rideElement);
            });
        }
    }

    async function fetchAvailableDrivers() {
        const data = await fetchData(`${API_BASE_URL}/api/drivers/available`, availableDriversList);
        if (!data) return;

        availableDriversList.innerHTML = '';
        if (data.available_drivers.length === 0) {
            availableDriversList.innerHTML = '<p class="text-gray-500">No drivers are currently available.</p>';
        } else {
            data.available_drivers.forEach(driver => {
                const driverElement = document.createElement('div');
                driverElement.className = 'border p-3 rounded-lg bg-green-50';
                driverElement.innerHTML = `<p class="font-semibold">${driver.name}</p><p class="text-sm text-gray-600">${driver.vehicle_details}</p>`;
                availableDriversList.appendChild(driverElement);
            });
        }
    }

    async function fetchAllDrivers() {
        const data = await fetchData(`${API_BASE_URL}/api/drivers/all`, allDriversList);
        if (!data) return;

        allDriversList.innerHTML = '';
        if (data.all_drivers.length === 0) {
            allDriversList.innerHTML = '<p class="text-gray-500">No drivers have been added yet.</p>';
        } else {
            data.all_drivers.forEach(driver => {
                const statusColor = driver.status === 'Available' ? 'text-green-600' : (driver.status === 'On Trip' ? 'text-yellow-600' : 'text-red-600');
                const driverElement = document.createElement('div');
                driverElement.className = 'border p-3 rounded-lg';
                driverElement.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${driver.name}</p>
                            <p class="text-sm text-gray-600">${driver.vehicle_details}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                             <span class="font-bold text-sm ${statusColor}">${driver.status}</span>
                             <select onchange="updateDriverStatus(${driver.driver_id}, this.value)" class="text-xs rounded border-gray-300">
                                <option value="">Change...</option>
                                <option value="Available">Available</option>
                                <option value="Offline">Offline</option>
                             </select>
                        </div>
                    </div>`;
                allDriversList.appendChild(driverElement);
            });
        }
    }

    // --- Action Functions ---
    async function handleAddDriver() {
        const name = driverNameInput.value.trim();
        const phone = driverPhoneInput.value.trim();
        const vehicle = vehicleDetailsInput.value.trim();

        if (!name || !phone || !vehicle) {
            addDriverStatus.textContent = 'All fields are required.';
            addDriverStatus.className = 'text-sm text-center mt-2 text-red-600';
            return;
        }

        try {
            addDriverStatus.textContent = 'Saving...';
            const response = await fetch(`${API_BASE_URL}/api/drivers/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone_number: phone, vehicle_details: vehicle })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'Failed to add driver');
            addDriverStatus.textContent = 'Driver added successfully!';
            driverNameInput.value = '';
            driverPhoneInput.value = '';
            vehicleDetailsInput.value = '';
            refreshAllData();
        } catch (error) {
            addDriverStatus.textContent = `Error: ${error.message}`;
        }
    }

    async function assignDriver(rideId, driverId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/ride/assign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ride_id: rideId, driver_id: driverId })
            });
            if (!response.ok) throw new Error('Failed to assign driver');
            alert('Success! Driver has been assigned.');
            closeModal();
            refreshAllData();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }
    
    async function updateDriverStatus(driverId, newStatus) {
        if (!newStatus) return;
        try {
            const response = await fetch(`${API_BASE_URL}/api/driver/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ driver_id: driverId, status: newStatus })
            });
            if (!response.ok) throw new Error('Failed to update status');
            refreshAllData();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    async function completeRide(rideId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/ride/complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ride_id: rideId })
            });
            if (!response.ok) throw new Error('Failed to complete ride');
            refreshAllData();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // --- Modal Handling ---
    async function openAssignModal(rideId) {
        selectedRideId = rideId;
        modalRideIdSpan.textContent = rideId;
        const data = await fetchData(`${API_BASE_URL}/api/drivers/available`, driverSelect);
        if (!data) {
            driverSelect.innerHTML = '<option value="">Could not load drivers</option>';
            return;
        }
        driverSelect.innerHTML = '<option value="">Select a driver...</option>';
        if (data.available_drivers.length > 0) {
            data.available_drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.driver_id;
                option.textContent = `${driver.name} - ${driver.vehicle_details}`;
                driverSelect.appendChild(option);
            });
        }
        modal.classList.remove('opacity-0', 'pointer-events-none');
        document.body.classList.add('modal-active');
    }

    function closeModal() {
        modal.classList.add('opacity-0', 'pointer-events-none');
        document.body.classList.remove('modal-active');
    }

    // --- Event Listeners ---
    refreshButton.addEventListener('click', refreshAllData);
    addDriverBtn.addEventListener('click', handleAddDriver);
    confirmAssignBtn.addEventListener('click', () => {
        const selectedDriverId = driverSelect.value;
        if (selectedRideId && selectedDriverId) {
            assignDriver(selectedRideId, parseInt(selectedDriverId));
        } else {
            alert('Please select a driver.');
        }
    });

    document.querySelector('.modal-overlay').addEventListener('click', closeModal);
    document.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal));

    // --- Initial Load ---
    window.onload = refreshAllData;
</script>
{% endblock %}
