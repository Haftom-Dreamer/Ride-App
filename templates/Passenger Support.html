{% extends "passenger_base.html" %}

{% block title %}{{ _('support_center') }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4">
    <div class="bg-white p-6 rounded-lg shadow-md dark:bg-gray-800">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">{{ _('support_center') }}</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2 mb-6">{{ _('support_intro') }}</p>

        <!-- Support Menu Options -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">{{ _('help_center') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="showSupportForm('Lost Item')">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-indigo-600 dark:text-indigo-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2m0 0a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('lost_item') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Report lost items</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="showSupportForm('Ride Complaint')">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-red-600 dark:text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('ride_complaint') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ _('report_ride_issue') }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="showSupportForm('Uber Integration')">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-blue-600 dark:text-blue-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('uber_integration') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Integration issues</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="showSupportForm('General Feedback')">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-green-600 dark:text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('general_feedback') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Share your thoughts</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="showFAQ()">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-purple-600 dark:text-purple-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('faq') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Frequently asked questions</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="contactSupport()">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-orange-600 dark:text-orange-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <div>
                            <h3 class="font-medium text-gray-900 dark:text-white">{{ _('contact_support') }}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Direct support contact</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Form -->
        <div id="support-form-container" class="hidden">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Submit Support Request</h3>
        <form id="support-form" class="space-y-6 max-w-lg">
            
            <div>
                <label for="feedback-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('what_can_we_help_with') }}</label>
                <select id="feedback-type" name="feedback_type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="" disabled selected>{{ _('select_issue_type') }}</option>
                    <option value="Lost Item">{{ _('lost_item') }}</option>
                    <option value="Ride Complaint">{{ _('ride_complaint') }}</option>
                        <option value="Uber Integration">{{ _('uber_integration') }}</option>
                    <option value="General Feedback">{{ _('general_feedback') }}</option>
                </select>
            </div>

            <div id="ride-selector-container" class="hidden">
                <label for="ride-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('which_ride') }}</label>
                <select id="ride-id" name="ride_id" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    <option value="" selected>{{ _('select_a_ride') }}</option>
                </select>
            </div>

            <div>
                <label for="details" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('provide_details') }}</label>
                <textarea id="details" name="details" rows="5" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
            </div>

            <div>
                <button type="submit" class="w-full sm:w-auto flex justify-center py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    {{ _('submit_report') }}
                </button>
            </div>
            <p id="form-feedback" class="text-sm mt-2"></p>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const typeSelect = document.getElementById('feedback-type');
    const rideContainer = document.getElementById('ride-selector-container');
    const rideSelect = document.getElementById('ride-id');
    const form = document.getElementById('support-form');
    const feedback = document.getElementById('form-feedback');
    const supportFormContainer = document.getElementById('support-form-container');

    const fetchRides = async () => {
        try {
            const res = await fetch('/api/passenger/ride-history');
            if(res.ok) {
                const rides = await res.json();
                rideSelect.innerHTML = `<option value="">{{ _('select_a_ride') }}</option>`; // Keep default
                rides.slice(0, 20).forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.textContent = `${r.request_time.split(' at ')[0]} - To: ${r.dest_address}`;
                    rideSelect.appendChild(opt);
                });
            }
        } catch (e) {
            console.error("Could not fetch rides for support form:", e);
        }
    };

    typeSelect.addEventListener('change', () => {
        const showRideSelector = ['Lost Item', 'Ride Complaint', 'Uber Integration', 'General Feedback'].includes(typeSelect.value);
        rideContainer.classList.toggle('hidden', !showRideSelector);
        rideSelect.required = showRideSelector;
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            feedback_type: form.elements.feedback_type.value,
            ride_id: form.elements.ride_id.value || null,
            details: form.elements.details.value
        };

        if (rideContainer.classList.contains('hidden')) {
            data.ride_id = null; // Ensure ride_id is null if not visible
        }

        try {
            const res = await fetch('/api/submit-support-ticket', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.error || 'Failed to submit.');
            feedback.textContent = "{{ _('report_submitted_successfully') }}";
            feedback.className = 'text-sm mt-2 text-green-600 dark:text-green-400';
            form.reset();
            rideContainer.classList.add('hidden');
            
            // Hide form and show success message
            setTimeout(() => {
                supportFormContainer.classList.add('hidden');
                feedback.textContent = '';
            }, 3000);
        } catch (err) {
            feedback.textContent = `{{ _('error') }}: ${err.message}`;
            feedback.className = 'text-sm mt-2 text-red-600 dark:text-red-400';
        }
    });

    fetchRides();
});

// Global functions for support menu
function showSupportForm(type) {
    const formContainer = document.getElementById('support-form-container');
    const typeSelect = document.getElementById('feedback-type');
    
    // Set the selected type
    typeSelect.value = type;
    
    // Show the form container
    formContainer.classList.remove('hidden');
    
    // Trigger change event to show/hide ride selector
    typeSelect.dispatchEvent(new Event('change'));
    
    // Scroll to form
    formContainer.scrollIntoView({ behavior: 'smooth' });
}

function showFAQ() {
    alert('FAQ section coming soon! We are working on adding frequently asked questions.');
}

function contactSupport() {
    alert('For immediate support, please call: +251-XXX-XXXX-XXX\nOr email us at: support@rideapp.com');
}
</script>
{% endblock %}
