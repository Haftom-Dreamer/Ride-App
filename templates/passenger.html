<!-- passenger.html -->
{% extends "base.html" %}

{% block title %}Request a Ride{% endblock %}

{% block head %}
    <style>
        /* Simple transition for showing/hiding steps */
        .step {
            transition: opacity 0.3s ease-in-out;
        }
        /* Style for disabled buttons */
        button:disabled {
            background-color: #a5b4fc; /* Lighter indigo */
            cursor: not-allowed;
        }
    </style>
{% endblock %}

{% block content %}
<div class="w-full max-w-md mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg mt-10">
    <div id="app-container">
        <!-- Step 1: Choose Ride Type -->
        <div id="step1" class="step">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">New Ride</h1>
            <p class="text-center text-gray-500 mb-8">Who is this ride for?</p>
            <div class="space-y-4">
                <button id="for-myself-btn" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all">
                    <div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">For Myself</p>
                        <p class="text-sm text-gray-500">Book a ride from your current location.</p>
                    </div>
                </button>
                <button id="for-someone-else-btn" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all">
                    <div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">For Someone Else</p>
                        <p class="text-sm text-gray-500">Set a custom pickup location.</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Step 2: Enter Ride Details -->
        <div id="step2" class="step hidden">
            <button class="back-btn text-sm text-gray-600 hover:text-gray-900 mb-4">&larr; Back</button>
            <h1 class="text-2xl font-bold text-gray-800 mb-6" id="step2-title"></h1>
            <div class="space-y-4">
                <!-- Pickup Location -->
                <div>
                    <label for="pickup-input" class="block text-sm font-medium text-gray-700">Pickup Location</label>
                    <div class="mt-1 flex rounded-md shadow-sm" id="pickup-container">
                        <!-- This will be dynamically populated -->
                    </div>
                    <p id="location-status" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <!-- Passenger Phone (for someone else) -->
                <div id="passenger-phone-section" class="hidden">
                    <label for="passenger-phone-input" class="block text-sm font-medium text-gray-700">Passenger's Phone Number</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">+251</span>
                        <input type="tel" id="passenger-phone-input" class="flex-1 block w-full rounded-none rounded-r-md sm:text-sm border-gray-300" placeholder="912345678">
                    </div>
                </div>
                <!-- Destination -->
                <div>
                    <label for="destination-input" class="block text-sm font-medium text-gray-700">Destination</label>
                    <input type="text" id="destination-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Where to?">
                </div>
                <!-- Continue Button -->
                <button id="calculate-fare-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    See Fare & Continue
                </button>
            </div>
        </div>

        <!-- Step 3: Confirmation -->
        <div id="step3" class="step hidden">
            <button class="back-btn text-sm text-gray-600 hover:text-gray-900 mb-4">&larr; Back</button>
            <h1 class="text-2xl font-bold text-gray-800 mb-4">Confirm Your Ride</h1>
            <div class="space-y-4">
                <div id="map" class="w-full h-48 bg-gray-200 rounded-md border"></div>
                <div class="bg-gray-50 p-4 rounded-md text-center">
                    <p class="text-sm text-gray-600">Estimated Fare</p>
                    <p class="text-2xl font-bold text-gray-900"><span id="fare-display">--</span> ETB</p>
                    <p class="text-xs text-gray-500">Distance: <span id="distance-display">--</span> km</p>
                </div>
                <!-- Your Phone (for myself) -->
                <div id="my-phone-section">
                    <label for="my-phone-input" class="block text-sm font-medium text-gray-700">Your Phone Number</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">+251</span>
                        <input type="tel" id="my-phone-input" class="flex-1 block w-full rounded-none rounded-r-md sm:text-sm border-gray-300" placeholder="912345678">
                    </div>
                </div>
                <button id="request-ride-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    Confirm & Request Ride
                </button>
            </div>
        </div>
    </div>
    <div id="response-message" class="text-center mt-4"></div>
</div>

<!-- IMPORTANT: You must get your own Google Maps API Key and replace "YOUR_API_KEY" -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap" async defer></script>

<script>
    // --- Configuration ---
    const API_BASE_URL = 'http://127.0.0.1:5000';
    const SERVICE_AREA = { north: 9.1, south: 8.9, east: 38.9, west: 38.6 };

    // --- Element Selectors ---
    const appContainer = document.getElementById('app-container');
    const steps = { 1: document.getElementById('step1'), 2: document.getElementById('step2'), 3: document.getElementById('step3') };
    const forMyselfBtn = document.getElementById('for-myself-btn');
    const forSomeoneElseBtn = document.getElementById('for-someone-else-btn');
    const step2Title = document.getElementById('step2-title');
    const pickupContainer = document.getElementById('pickup-container');
    const locationStatus = document.getElementById('location-status');
    const passengerPhoneSection = document.getElementById('passenger-phone-section');
    const passengerPhoneInput = document.getElementById('passenger-phone-input');
    const destinationInput = document.getElementById('destination-input');
    const calculateFareBtn = document.getElementById('calculate-fare-btn');
    const mapDiv = document.getElementById('map');
    const fareDisplay = document.getElementById('fare-display');
    const distanceDisplay = document.getElementById('distance-display');
    const myPhoneSection = document.getElementById('my-phone-section');
    const myPhoneInput = document.getElementById('my-phone-input');
    const requestRideBtn = document.getElementById('request-ride-btn');
    const responseMessage = document.getElementById('response-message');

    // --- State Variables ---
    let rideType = null;
    let userPickup = null;
    let userDestination = null;
    let rideDetails = null;
    let map, directionsService, directionsRenderer, geocoder;
    let pickupAutocomplete, destinationAutocomplete;

    // --- UI Navigation ---
    function goToStep(stepNumber) {
        Object.values(steps).forEach(step => step.classList.add('hidden'));
        steps[stepNumber].classList.remove('hidden');
    }

    // --- Google Maps Initialization ---
    function initMap() {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        geocoder = new google.maps.Geocoder();
        map = new google.maps.Map(mapDiv, { center: { lat: 9.03, lng: 38.74 }, zoom: 12, disableDefaultUI: true });
        directionsRenderer.setMap(map);

        destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, { componentRestrictions: { country: 'et' } });
        destinationAutocomplete.setFields(['name', 'geometry']);
        destinationAutocomplete.addListener('place_changed', () => {
             const place = destinationAutocomplete.getPlace();
             if (place.geometry) {
                userDestination = { lat: place.geometry.location.lat(), lon: place.geometry.location.lng(), address: place.name };
             }
        });
    }
    
    // --- Event Handlers ---
    forMyselfBtn.addEventListener('click', () => setupStep2('myself'));
    forSomeoneElseBtn.addEventListener('click', () => setupStep2('someoneElse'));
    appContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('back-btn')) {
            const currentStep = e.target.closest('.step').id.replace('step', '');
            if (currentStep === '2') goToStep(1);
            if (currentStep === '3') goToStep(2);
        }
    });
    calculateFareBtn.addEventListener('click', calculateRouteAndFare);
    requestRideBtn.addEventListener('click', handleRideRequest);

    // --- Core Logic ---
    function setupStep2(type) {
        rideType = type;
        resetStep2();
        if (type === 'myself') {
            step2Title.textContent = 'Set your destination';
            pickupContainer.innerHTML = `
                <button id="get-location-btn" class="relative inline-flex items-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-l-md text-gray-700 bg-gray-50 hover:bg-gray-100">Find Me</button>
                <input type="text" id="pickup-input" class="flex-1 block w-full rounded-none rounded-r-md sm:text-sm border-gray-300" placeholder="Enter pickup or use Find Me">`;
            document.getElementById('get-location-btn').addEventListener('click', getUserLocation);
            passengerPhoneSection.classList.add('hidden');
        } else {
            step2Title.textContent = 'Enter ride details';
            pickupContainer.innerHTML = `<input type="text" id="pickup-input" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter pickup address">`;
            passengerPhoneSection.classList.remove('hidden');
        }
        
        const pickupInput = document.getElementById('pickup-input');
        pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, { componentRestrictions: { country: 'et' } });
        pickupAutocomplete.setFields(['name', 'geometry']);
        pickupAutocomplete.addListener('place_changed', handlePickupSelect);

        goToStep(2);
    }

    function getUserLocation() {
        if (!navigator.geolocation) return setStatus('Geolocation is not supported.', 'red');
        setStatus('Finding your location...', 'blue');
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                if (latitude < SERVICE_AREA.south || latitude > SERVICE_AREA.north || longitude < SERVICE_AREA.west || longitude > SERVICE_AREA.east) {
                    return setStatus('Sorry, service is not available in your current location.', 'red');
                }
                geocoder.geocode({ 'location': { lat: latitude, lng: longitude } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        userPickup = { lat: latitude, lon: longitude, address: results[0].formatted_address };
                        document.getElementById('pickup-input').value = userPickup.address;
                        setStatus('Location found!', 'green');
                    } else {
                        setStatus('Could not determine address from location.', 'red');
                    }
                });
            },
            () => setStatus('Please enable location services.', 'red')
        );
    }

    function handlePickupSelect() {
        const place = pickupAutocomplete.getPlace();
        if (place.geometry) {
            userPickup = { lat: place.geometry.location.lat(), lon: place.geometry.location.lng(), address: place.name };
        }
    }

    async function calculateRouteAndFare() {
        if (!userPickup || !userDestination) {
            alert("Please select both a pickup and destination location.");
            return;
        }
        try {
            calculateFareBtn.disabled = true;
            calculateFareBtn.textContent = "Calculating...";
            const response = await fetch(`${API_BASE_URL}/api/fare-estimate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pickup_lat: userPickup.lat, pickup_lon: userPickup.lon,
                    dest_lat: userDestination.lat, dest_lon: userDestination.lon
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Could not calculate fare.');
            
            rideDetails = data;
            fareDisplay.textContent = rideDetails.estimated_fare;
            distanceDisplay.textContent = rideDetails.distance_km;

            directionsService.route({
                origin: { lat: userPickup.lat, lng: userPickup.lon },
                destination: { lat: userDestination.lat, lng: userDestination.lon },
                travelMode: 'DRIVING'
            }, (result, status) => {
                if (status == 'OK') directionsRenderer.setDirections(result);
            });
            
            myPhoneSection.style.display = rideType === 'myself' ? 'block' : 'none';
            goToStep(3);

        } catch (error) {
            setStatus(error.message, 'red');
        } finally {
            calculateFareBtn.disabled = false;
            calculateFareBtn.textContent = "See Fare & Continue";
        }
    }

    async function handleRideRequest() {
        const phone = rideType === 'myself' ? myPhoneInput.value.trim() : passengerPhoneInput.value.trim();
        if (!phone) return showMessage('Please enter the passenger\'s phone number.', 'red');

        const rideData = {
            phone_number: `+251${phone}`,
            pickup_lat: userPickup.lat, pickup_lon: userPickup.lon,
            dest_address: userDestination.address,
            distance_km: rideDetails.distance_km, fare: rideDetails.estimated_fare
        };

        try {
            showMessage('Sending your request...', 'blue');
            requestRideBtn.disabled = true;

            const response = await fetch(`${API_BASE_URL}/api/ride-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rideData),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'An unknown error occurred.');

            appContainer.innerHTML = `
                <div class="text-center py-8">
                    <div class="mx-auto bg-green-100 text-green-600 w-16 h-16 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mt-4">Request Sent!</h2>
                    <p class="text-gray-600 mt-2">Your request has been received. The dispatcher will be in contact shortly.</p>
                </div>`;

        } catch (error) {
            showMessage(`Error: ${error.message}.`, 'red');
            requestRideBtn.disabled = false;
        }
    }

    // --- Helper Functions ---
    function setStatus(message, color) {
        locationStatus.textContent = message;
        locationStatus.className = `text-xs text-${color}-500 mt-1`;
    }
    function showMessage(message, color) {
        responseMessage.textContent = message;
        responseMessage.className = `text-center mt-4 text-sm font-medium text-${color}-600`;
    }
    function resetStep2() {
        userPickup = null;
        userDestination = null;
        destinationInput.value = '';
        passengerPhoneInput.value = '';
        locationStatus.textContent = '';
        pickupContainer.innerHTML = '';
        responseMessage.textContent = '';
    }
</script>
{% endblock %}
