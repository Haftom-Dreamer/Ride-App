{% extends "base.html" %}

{% block title %}Request a Ride{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    body {
        background-color: #f8fafc;
        font-family: 'Inter', sans-serif;
    }

    #main-container {
        transition: all 0.5s ease-in-out;
    }

    .autocomplete-suggestions {
        border: 1px solid #e5e7eb;
        border-top: none;
        max-height: 150px;
        overflow-y: auto;
        position: absolute;
        background: #ffffff;
        z-index: 1000;
        width: 100%;
        border-radius: 0 0 0.5rem 0.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .autocomplete-suggestion,
    .autocomplete-searching {
        padding: 10px;
        cursor: pointer;
    }

    .autocomplete-suggestion:hover {
        background-color: #f3f4f6;
    }

    .loader-car {
        position: relative;
        width: 120px;
        height: 120px;
        margin: auto;
    }

    .loader-car::before,
    .loader-car::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        border: 6px solid #e5e7eb;
        animation: spin 1.5s linear infinite;
    }

    .loader-car::after {
        border-top-color: #4f46e5;
        animation-delay: 0.25s;
    }

    .car-icon-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 40px;
        color: #4f46e5;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .vehicle-option {
        border: 2px solid #e5e7eb;
        transition: all 0.2s ease-in-out;
    }

    .vehicle-option.selected {
        border-color: #4f46e5;
        background-color: #eef2ff;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        transform: scale(1.02);
    }

    .vehicle-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .rating-stars .star {
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.2s;
        font-size: 2.5rem;
    }

    .rating-stars .star.highlight {
        color: #f59e0b;
    }

    .status-screen {
        display: none;
    }

    #road-animation-container {
        width: 100%;
        height: 80px;
        background: #e5e7eb;
        border-radius: 0.5rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        position: relative;
        overflow: hidden;
    }

    #road-lines {
        position: absolute;
        top: 50%;
        left: -10%;
        width: 120%;
        height: 4px;
        background-image: linear-gradient(to right, #ffffff 50%, transparent 50%);
        background-size: 40px 4px;
        animation: move-lines 2s linear infinite;
    }

    #car-animation-icon {
        position: absolute;
        bottom: 10px;
        font-size: 3rem;
        animation: drive 6s linear infinite;
    }

    @keyframes move-lines {
        from {
            background-position-x: 0;
        }

        to {
            background-position-x: -80px;
        }
    }

    @keyframes drive {
        0% {
            left: -60px;
            transform: scaleX(1);
        }

        45% {
            left: calc(100% - 20px);
            transform: scaleX(1);
        }

        55% {
            left: calc(100% - 20px);
            transform: scaleX(-1);
        }

        95% {
            left: -60px;
            transform: scaleX(-1);
        }

        100% {
            left: -60px;
            transform: scaleX(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="main-container" class="w-full max-w-lg mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow-xl mt-8">

    <!-- Booking UI -->
    <div id="booking-container">
        <h1 class="text-3xl font-bold text-center text-gray-900">Where to?</h1>
        <p class="text-center text-gray-500 mt-2 mb-6">Request a ride in just a few clicks.</p>

        <div id="map" class="w-full h-64 bg-gray-200 rounded-lg border my-4 shadow-inner"></div>
        <p id="map-instruction" class="text-center text-sm text-indigo-600 font-medium mb-4"></p>

        <div class="space-y-4">
            <div class="relative"><label for="pickup-input" class="block text-sm font-medium text-gray-700">Pickup
                    Location</label>
                <div class="mt-1 flex items-center relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg
                            class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                                clip-rule="evenodd" />
                        </svg></div><input type="text" id="pickup-input"
                        class="w-full pl-10 pr-20 py-2 border border-gray-300 rounded-md shadow-sm"
                        placeholder="Enter pickup address"><button id="get-location-btn"
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-indigo-600 font-semibold hover:text-indigo-800">Find
                        Me</button>
                </div>
                <p id="location-status" class="text-xs text-gray-500 mt-1"></p>
                <div id="pickup-suggestions" class="autocomplete-suggestions"></div>
            </div>
            <div class="relative"><label for="destination-input"
                    class="block text-sm font-medium text-gray-700">Destination</label>
                <div class="mt-1 flex items-center relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg
                            class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path
                                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                        </svg></div><input type="text" id="destination-input"
                        class="w-full pl-10 py-2 border border-gray-300 rounded-md shadow-sm"
                        placeholder="Enter destination">
                </div>
                <div id="destination-suggestions" class="autocomplete-suggestions"></div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Vehicle</label>
                <div id="vehicle-options" class="grid grid-cols-2 gap-4">
                    <button class="vehicle-option p-2 border rounded-lg flex flex-col items-center justify-center"
                        data-vehicle="Bajaj"><img src="{{ url_for('static', filename='img/bajaj.png') }}" alt="Bajaj"
                            class="h-16 mb-1 pointer-events-none">
                        <p class="font-semibold pointer-events-none">Regular</p>
                    </button>
                    <button
                        class="vehicle-option p-2 border rounded-lg flex flex-col items-center justify-center disabled"
                        data-vehicle="Car"><img src="{{ url_for('static', filename='img/car.png') }}" alt="Car"
                            class="h-16 mb-1 pointer-events-none">
                        <p class="font-semibold pointer-events-none">Comfort</p>
                        <p class="text-xs text-gray-400 pointer-events-none">Coming Soon</p>
                    </button>
                </div>
            </div>

            <div>
                <label for="ride-note-input" class="block text-sm font-medium text-gray-700">Note for Driver
                    (Optional)</label>
                <textarea id="ride-note-input" rows="2"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm"
                    placeholder="e.g., I am wearing a red shirt"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div id="fare-info" class="bg-gray-50 p-3 rounded-lg text-center hidden">
                    <p class="text-sm text-gray-600">Fare: <strong class="text-gray-900"><span
                                id="fare-display">--</span> ETB</strong></p>
                    <p class="text-xs text-gray-500">Distance: <span id="distance-display">--</span> km</p>
                </div>
                <div class="col-span-2" id="phone-container"><label for="phone-input"
                        class="block text-sm font-medium text-gray-700">Your Phone Number</label>
                    <div class="mt-1 flex rounded-md shadow-sm"><span
                            class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">+251</span><input
                            type="tel" id="phone-input"
                            class="flex-1 block w-full rounded-none rounded-r-md border-gray-300"
                            placeholder="912345678"></div>
                </div>
            </div>
            <button id="request-ride-btn"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 transition-all">Request
                Ride</button>
        </div>
    </div>

    <!-- Status Screens -->
    <div id="waiting-screen" class="status-screen text-center py-12">
        <div class="loader-car">
            <div class="car-icon-loader">ðŸš—</div>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mt-8">Finding your driver...</h2>
        <p class="text-gray-600 mt-2">Connecting you with a nearby professional.</p><button id="cancel-request-btn"
            class="mt-6 text-sm text-red-600 hover:text-red-800 font-semibold">Cancel Request</button>
    </div>

    <div id="assigned-screen" class="status-screen">
        <h2 class="text-2xl font-bold text-center text-gray-800">Your driver is on the way!</h2>
        <div id="road-animation-container">
            <div id="road-lines"></div>
            <div id="car-animation-icon">ðŸš—</div>
        </div>
        <div class="text-left p-4 bg-gray-50 rounded-lg border">
            <div class="flex items-center">
                <div class="bg-gray-200 rounded-full h-12 w-12 flex-shrink-0"></div>
                <div class="ml-4">
                    <p id="driver-name" class="text-lg font-bold text-gray-900"></p>
                    <p class="text-sm text-gray-500">Your Driver</p>
                </div>
            </div>
            <div class="mt-4 border-t pt-4 space-y-2">
                <p><strong>Vehicle:</strong> <span id="driver-vehicle"></span></p>
                <p><strong>Contact:</strong> <span id="driver-phone"></span></p>
            </div>
            <a id="call-driver-btn" href="#"
                class="mt-4 w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-full shadow-sm text-md font-bold text-white bg-green-600 hover:bg-green-700 transition-all"><svg
                    xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                </svg>Call Driver</a>
        </div>
    </div>

    <div id="canceled-screen" class="status-screen text-center py-12">
        <h2 class="text-2xl font-bold text-gray-800">Ride Canceled</h2><button id="new-ride-btn"
            class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-full font-bold">Request a New Ride</button>
    </div>

    <div id="summary-screen" class="status-screen text-center py-12">
        <h2 class="text-3xl font-bold text-gray-800">Ride Completed!</h2>
        <div class="mt-6 text-left p-6 bg-gray-50 rounded-lg border">
            <p><strong>Destination:</strong> <span id="summary-dest"></span></p>
            <p><strong>Final Fare:</strong> <span id="summary-fare"></span> ETB</p>
        </div>
        <div class="mt-8">
            <p class="text-lg font-semibold text-gray-700">How was your ride?</p>
            <div id="rating-stars" class="rating-stars flex justify-center text-4xl mt-2">
                <span class="star" data-value="1">â˜…</span><span class="star" data-value="2">â˜…</span><span class="star"
                    data-value="3">â˜…</span><span class="star" data-value="4">â˜…</span><span class="star"
                    data-value="5">â˜…</span>
            </div>
            <textarea id="rating-comment" class="mt-4 w-full border border-gray-300 rounded-md shadow-sm hidden"
                rows="3" placeholder="Add an optional comment..."></textarea>
            <button id="submit-rating-btn"
                class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-full font-semibold hidden">Submit
                Feedback</button>
        </div>
        <div id="rating-thanks" class="mt-4 text-green-600 font-semibold hidden">Thank you for your feedback!</div>
        <button id="done-btn" class="mt-6 px-6 py-3 bg-gray-600 text-white rounded-full font-bold">Done</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App State ---
        let selectedVehicle = 'Bajaj';
        let selectedRating = 0;
        let pollingInterval = null, currentRideId = null;
        let userPickup = null, userDestination = null, rideDetails = null;
        let map, pickupMarker, destinationMarker, routeLayer;
        let searchTimeout;

        // --- Constants ---
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        const commonLandmarks = [{ "name": "Adigrat University", "lat": 14.283, "lon": 39.462, "display_name": "Adigrat University, Adigrat" }, { "name": "St. George's Church", "lat": 14.276, "lon": 39.459, "display_name": "St. George's Church, Adigrat" }, { "name": "Adigrat General Hospital", "lat": 14.270, "lon": 39.465, "display_name": "Adigrat General Hospital, Adigrat" }, { "name": "Martyrs Memorial Monument", "lat": 14.278, "lon": 39.468, "display_name": "Martyrs Memorial Monument, Adigrat" }, { "name": "Central Market (Mercato)", "lat": 14.275, "lon": 39.461, "display_name": "Central Market (Mercato), Adigrat" }, { "name": "Adigrat Bus Station", "lat": 14.272, "lon": 39.458, "display_name": "Adigrat Bus Station, Adigrat" }, { "name": "Medhane Alem Cathedral", "lat": 14.279, "lon": 39.455, "display_name": "Medhane Alem Cathedral, Adigrat" }, { "name": "Gebre's Hotel", "lat": 14.277, "lon": 39.462, "display_name": "Gebre's Hotel, Adigrat" }, { "name": "Agazi School", "lat": 14.274, "lon": 39.463, "display_name": "Agazi School, Adigrat" }, { "name": "Commercial Bank of Ethiopia", "lat": 14.275, "lon": 39.460, "display_name": "Commercial Bank of Ethiopia, Adigrat" }, { "name": "Total Gas Station", "lat": 14.271, "lon": 39.459, "display_name": "Total Gas Station, Adigrat" }, { "name": "Adigrat Stadium", "lat": 14.280, "lon": 39.470, "display_name": "Adigrat Stadium, Adigrat" }, { "name": "Abune Aregawi Church", "lat": 14.281, "lon": 39.458, "display_name": "Abune Aregawi Church, Adigrat" }];

        // --- Element Selectors ---
        const bookingContainer = document.getElementById('booking-container');
        const waitingScreen = document.getElementById('waiting-screen');
        const assignedScreen = document.getElementById('assigned-screen');
        const canceledScreen = document.getElementById('canceled-screen');
        const summaryScreen = document.getElementById('summary-screen');
        const mapInstruction = document.getElementById('map-instruction');
        const pickupInput = document.getElementById('pickup-input');
        const destinationInput = document.getElementById('destination-input');
        const locationStatus = document.getElementById('location-status');
        const fareInfo = document.getElementById('fare-info');
        const fareDisplay = document.getElementById('fare-display');
        const distanceDisplay = document.getElementById('distance-display');
        const phoneInput = document.getElementById('phone-input');
        const noteInput = document.getElementById('ride-note-input');
        const requestRideBtn = document.getElementById('request-ride-btn');
        const pickupSuggestions = document.getElementById('pickup-suggestions');
        const destinationSuggestions = document.getElementById('destination-suggestions');
        const cancelRequestBtn = document.getElementById('cancel-request-btn');
        const newRideBtn = document.getElementById('new-ride-btn');
        const callDriverBtn = document.getElementById('call-driver-btn');
        const ratingStars = document.getElementById('rating-stars');
        const ratingComment = document.getElementById('rating-comment');
        const submitRatingBtn = document.getElementById('submit-rating-btn');
        const ratingThanks = document.getElementById('rating-thanks');
        const doneBtn = document.getElementById('done-btn');

        // --- Helper Functions ---
        const showScreen = (screenName) => {
            [bookingContainer, waitingScreen, assignedScreen, canceledScreen, summaryScreen].forEach(el => el.style.display = 'none');
            const screenToShow = document.getElementById(`${screenName}-container`) || document.getElementById(`${screenName}-screen`);
            if (screenToShow) screenToShow.style.display = 'block';
        };

        const setStatus = (message, color) => {
            locationStatus.textContent = message;
            locationStatus.className = `text-xs text-${color}-500 mt-1`;
        };

        // --- Main Logic ---
        const init = () => {
            initLeafletMap('map');
            updateMapInstruction();
            requestRideBtn.disabled = true;

            document.getElementById('get-location-btn').addEventListener('click', getUserLocation);
            requestRideBtn.addEventListener('click', handleRideRequest);
            cancelRequestBtn.addEventListener('click', handleCancelRequest);
            newRideBtn.addEventListener('click', () => window.location.reload());
            doneBtn.addEventListener('click', () => window.location.reload());

            setupAutocomplete(pickupInput, pickupSuggestions, (place) => {
                userPickup = { lat: parseFloat(place.lat), lon: parseFloat(place.lon), address: place.display_name };
                updateMapAndFare();
            });
            setupAutocomplete(destinationInput, destinationSuggestions, (place) => {
                userDestination = { lat: parseFloat(place.lat), lon: parseFloat(place.lon), address: place.display_name };
                updateMapAndFare();
            });

            const vehicleOptions = document.getElementById('vehicle-options');
            vehicleOptions.addEventListener('click', (e) => {
                const button = e.target.closest('.vehicle-option');
                if (button && !button.classList.contains('disabled')) {
                    vehicleOptions.querySelectorAll('.vehicle-option').forEach(opt => opt.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedVehicle = button.dataset.vehicle;
                    if (userPickup && userDestination) calculateFare();
                }
            });
            vehicleOptions.querySelector('[data-vehicle="Bajaj"]').classList.add('selected');

            ratingStars.addEventListener('mouseover', (e) => { if (e.target.classList.contains('star')) highlightStars(e.target.dataset.value); });
            ratingStars.addEventListener('mouseout', () => highlightStars(selectedRating));
            ratingStars.addEventListener('click', (e) => {
                if (e.target.classList.contains('star')) {
                    selectedRating = e.target.dataset.value;
                    highlightStars(selectedRating);
                    ratingComment.classList.remove('hidden');
                    submitRatingBtn.classList.remove('hidden');
                }
            });
            submitRatingBtn.addEventListener('click', () => submitRating(selectedRating, ratingComment.value));
        };

        const handleRideRequest = () => {
            if (!userPickup || !userDestination || !rideDetails) return;
            const phone = phoneInput.value.trim();
            if (!phone || phone.length < 9) return alert('Please enter a valid phone number.');
            const rideData = { 
                phone_number: `+251${phone}`,
                pickup_address: userPickup.address,
                pickup_lat: userPickup.lat, 
                pickup_lon: userPickup.lon, 
                dest_address: userDestination.address, 
                dest_lat: userDestination.lat,
                dest_lon: userDestination.lon,
                distance_km: rideDetails.distance_km, 
                fare: rideDetails.estimated_fare, 
                vehicle_type: selectedVehicle, 
                note: noteInput.value.trim() 
            };

            requestRideBtn.disabled = true;
            requestRideBtn.textContent = 'Requesting...';

            fetch(`${API_BASE_URL}/ride-request`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(rideData) })
                .then(res => res.json())
                .then(result => {
                    if (!result.ride_id) throw new Error(result.error || 'Failed to get ride ID.');
                    currentRideId = result.ride_id;
                    showScreen('waiting');
                    startPolling(currentRideId);
                })
                .catch(error => { alert(`Error: ${error.message}`); requestRideBtn.disabled = false; requestRideBtn.textContent = 'Request Ride'; });
        };

        const calculateFare = async () => {
            if (!userPickup || !userDestination || !selectedVehicle) return;
            fareDisplay.textContent = "...";
            distanceDisplay.textContent = "...";
            try {
                const response = await fetch(`${API_BASE_URL}/fare-estimate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pickup_lat: userPickup.lat, pickup_lon: userPickup.lon, dest_lat: userDestination.lat, dest_lon: userDestination.lon, vehicle_type: selectedVehicle }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Could not calculate fare.');
                rideDetails = data;
                fareDisplay.textContent = rideDetails.estimated_fare;
                distanceDisplay.textContent = rideDetails.distance_km;
            } catch (error) { setStatus(error.message, 'red'); }
        };

        const startPolling = (rideId) => {
            pollingInterval = setInterval(() => checkRideStatus(rideId), 3000);
        };

        const checkRideStatus = (rideId) => {
            fetch(`${API_BASE_URL}/ride-status/${rideId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'Completed') {
                        clearInterval(pollingInterval);
                        displayRideSummary(data.ride_details);
                        return;
                    }
                    if (data.status === 'Canceled') {
                        clearInterval(pollingInterval);
                        showScreen('canceled');
                        return;
                    }
                    if (data.status === 'Assigned' && assignedScreen.style.display === 'none') {
                        displayAssignedDriver(data.driver);
                    }
                }).catch(err => {
                    console.error('Polling error:', err);
                    clearInterval(pollingInterval);
                });
        };

        const displayAssignedDriver = (driverInfo) => {
            showScreen('assigned');
            document.getElementById('driver-name').textContent = driverInfo.name;
            document.getElementById('driver-phone').textContent = driverInfo.phone_number;
            document.getElementById('driver-vehicle').textContent = driverInfo.vehicle_details;
            callDriverBtn.href = `tel:${driverInfo.phone_number}`;
        };

        const displayRideSummary = (details) => {
            showScreen('summary');
            document.getElementById('summary-dest').textContent = details.dest_address;
            document.getElementById('summary-fare').textContent = details.fare;
        };

        const highlightStars = (rating) => {
            ratingStars.querySelectorAll('.star').forEach(star => star.classList.toggle('highlight', star.dataset.value <= rating));
        };

        const submitRating = async (rating, comment) => {
            try {
                await fetch(`${API_BASE_URL}/rate-ride`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ride_id: currentRideId, rating: rating, comment: comment })
                });
                ratingStars.style.display = 'none';
                ratingComment.style.display = 'none';
                submitRatingBtn.style.display = 'none';
                ratingThanks.classList.remove('hidden');
            } catch (error) { console.error("Failed to submit rating", error); }
        };

        const initLeafletMap = (mapId) => {
            const targetMapEl = document.getElementById(mapId);
            if (targetMapEl && targetMapEl._leaflet_id) { return; }
            const newMap = L.map(mapId).setView([14.275, 39.46], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(newMap);
            if (mapId === 'map') {
                map = newMap;
                map.on('click', handleMapClick);
            }
        };

        function handleCancelRequest() { if (!currentRideId) return; fetch(`${API_BASE_URL}/cancel-ride`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ride_id: currentRideId }) }); }
        function handleMapClick(e) { const { lat, lng } = e.latlng; const isSettingPickup = !userPickup || (userPickup && userDestination); const targetInput = isSettingPickup ? pickupInput : destinationInput; setStatus('Fetching address...', 'blue'); fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`).then(res => res.json()).then(data => { if (!data || !data.display_name) throw new Error('Could not find address.'); const location = { lat: lat, lon: lng, address: data.display_name }; targetInput.value = location.address; if (isSettingPickup) { userPickup = location; userDestination = null; destinationInput.value = ''; } else { userDestination = location; } setStatus(isSettingPickup ? 'Pickup set!' : 'Destination set!', 'green'); updateMapAndFare(); }).catch(err => setStatus(err.message, 'red')); }
        function setupAutocomplete(inputEl, suggestionsEl, callback) { suggestionsEl.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('autocomplete-suggestion')) { const placeData = JSON.parse(e.target.dataset.place); inputEl.value = placeData.display_name; suggestionsEl.innerHTML = ''; callback(placeData); } }); inputEl.addEventListener('input', () => { clearTimeout(searchTimeout); const query = inputEl.value.toLowerCase(); suggestionsEl.innerHTML = ''; if (query.length < 1) return; const localResults = commonLandmarks.filter(place => place.name.toLowerCase().includes(query)); localResults.forEach(place => renderSuggestion(place, suggestionsEl)); const searchingMsg = document.createElement('div'); searchingMsg.className = 'autocomplete-searching'; searchingMsg.textContent = 'Searching for more...'; suggestionsEl.appendChild(searchingMsg); searchTimeout = setTimeout(async () => { const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&viewbox=39.44,14.26,39.48,14.29&bounded=1&countrycodes=et`; try { const response = await fetch(url); const apiResults = await response.json(); searchingMsg.remove(); apiResults.slice(0, 5).forEach(place => { if (!localResults.some(local => local.name === place.name)) { renderSuggestion(place, suggestionsEl); } }); } catch (error) { console.error("Autocomplete API error:", error); searchingMsg.textContent = 'Search error.'; } }, 300); }); document.addEventListener('click', e => { if (e.target !== inputEl) suggestionsEl.innerHTML = ''; }); }
        function renderSuggestion(place, suggestionsEl) { const div = document.createElement('div'); div.innerHTML = place.display_name; div.className = 'autocomplete-suggestion'; div.dataset.place = JSON.stringify({ lat: place.lat, lon: place.lon, display_name: place.display_name }); suggestionsEl.appendChild(div); }
        function getUserLocation() { setStatus('Finding your location...', 'blue'); navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`).then(res => res.json()).then(data => { const lon = parseFloat(data.lon), lat = parseFloat(data.lat), v = "39.44,14.26,39.48,14.29".split(','); if (lon >= parseFloat(v[0]) && lon <= parseFloat(v[2]) && lat >= parseFloat(v[1]) && lat <= parseFloat(v[3])) { userPickup = { lat: latitude, lon: longitude, address: data.display_name || "Current Location" }; pickupInput.value = userPickup.address; setStatus('Location found!', 'green'); updateMapAndFare(); } else { setStatus('Service is only available in Adigrat.', 'red'); userPickup = null; } }); }, () => setStatus('Please enable location services.', 'red')); }
        function updateMapAndFare() { if (pickupMarker) map.removeLayer(pickupMarker); if (destinationMarker) map.removeLayer(destinationMarker); if (routeLayer) map.removeLayer(routeLayer); if (userPickup) pickupMarker = L.marker([userPickup.lat, userPickup.lon]).addTo(map).bindPopup('Pickup').openPopup(); if (userDestination) destinationMarker = L.marker([userDestination.lat, userDestination.lon]).addTo(map).bindPopup('Destination'); if (userPickup && userDestination) { drawRouteOnMap(userPickup, userDestination, map); calculateFare(); fareInfo.classList.remove('hidden'); requestRideBtn.disabled = false; } else { fareInfo.classList.add('hidden'); requestRideBtn.disabled = true; } if (userPickup) map.setView([userPickup.lat, userPickup.lon], 16); updateMapInstruction(); }
        function updateMapInstruction() { mapInstruction.classList.remove('hidden'); if (!userPickup) { mapInstruction.textContent = 'Click on the map or search to set your pickup location.'; } else if (!userDestination) { mapInstruction.textContent = 'Now, click on the map or search to set your destination.'; } else { mapInstruction.classList.add('hidden'); } }
        async function drawRouteOnMap(pickup, destination, targetMap) { const currentMap = targetMap || map; const url = `https://router.project-osrm.org/route/v1/driving/${pickup.lon},${pickup.lat};${destination.lon},${destination.lat}?overview=full&geometries=geojson`; try { const response = await fetch(url); const data = await response.json(); if (data.routes && data.routes.length > 0) { const routeCoords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]); const routeLine = L.polyline(routeCoords, { color: '#6d28d9', weight: 5 }).addTo(currentMap); currentMap.fitBounds(routeLine.getBounds(), { padding: [50, 50] }); } } catch (error) { console.error('Error fetching route:', error); } }

        init();
    });
</script>
{% endblock %}
