{% extends "base.html" %}

{% block title %}Request a Ride{% endblock %}

{% block head %}
    <!-- Leaflet CSS for map display -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        .step { transition: opacity 0.3s ease-in-out; }
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background: #fff;
            z-index: 9999;
            width: 100%; 
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="w-full max-w-md mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg mt-10">
    <div id="app-container">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">New Ride</h1>
        
        <!-- Map is now a permanent fixture at the top -->
        <div id="map" class="w-full h-56 bg-gray-200 rounded-md border my-4"></div>
        <p id="map-instruction" class="text-center text-sm text-indigo-600 mb-4 hidden"></p>

        <!-- Step 1: Choose Ride Type -->
        <div id="step1" class="step">
            <p class="text-center text-gray-500 mb-6">Who is this ride for?</p>
            <div class="space-y-4">
                 <button id="for-myself-btn" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all">
                    <div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">For Myself</p>
                        <p class="text-sm text-gray-500">Book using your current location.</p>
                    </div>
                </button>
                <button id="for-someone-else-btn" class="w-full flex items-center text-left p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all">
                    <div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">For Someone Else</p>
                        <p class="text-sm text-gray-500">Manually set a pickup location.</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- Step 2: Enter Ride Details -->
        <div id="step2" class="step hidden">
            <button class="back-btn text-sm text-gray-600 hover:text-gray-900 mb-4">&larr; Back</button>
            <div class="space-y-4 relative">
                <!-- Pickup Location -->
                <div class="relative">
                    <label for="pickup-input" class="block text-sm font-medium text-gray-700">Pickup Location</label>
                    <div class="mt-1 flex rounded-md shadow-sm" id="pickup-container"></div>
                    <p id="location-status" class="text-xs text-gray-500 mt-1"></p>
                    <div id="pickup-suggestions" class="autocomplete-suggestions"></div>
                </div>
                
                <!-- Destination -->
                <div class="relative">
                    <label for="destination-input" class="block text-sm font-medium text-gray-700">Destination</label>
                    <input type="text" id="destination-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Where to?">
                    <div id="destination-suggestions" class="autocomplete-suggestions"></div>
                </div>

                <!-- Fare Info -->
                <div class="flex justify-around items-center bg-gray-50 p-4 rounded-md text-center">
                    <div class="w-1/2">
                        <p class="text-sm text-gray-600">Estimated Fare</p>
                        <p class="text-xl font-bold text-gray-900 flex items-center justify-center space-x-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                             </svg>
                             <span><span id="fare-display">--</span> ETB</span>
                        </p>
                    </div>
                    <div class="border-l border-gray-200 h-12"></div>
                    <div class="w-1/2">
                        <p class="text-sm text-gray-600">Distance</p>
                        <p class="text-xl font-bold text-gray-900 flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h4.5M12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                            </svg>
                             <span><span id="distance-display">--</span> km</span>
                        </p>
                    </div>
                </div>
                
                <!-- Phone Input -->
                <div id="phone-section">
                     <label for="phone-input" class="block text-sm font-medium text-gray-700" id="phone-label"></label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">+251</span>
                        <input type="tel" id="phone-input" class="flex-1 block w-full rounded-none rounded-r-md sm:text-sm border-gray-300" placeholder="912345678">
                    </div>
                </div>

                <!-- Request Button -->
                <button id="request-ride-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    Confirm & Request Ride
                </button>
            </div>
        </div>
    </div>
    <div id="response-message" class="text-center mt-4"></div>
</div>

<!-- Leaflet JavaScript for map display -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- Configuration ---
    const API_BASE_URL = 'http://127.0.0.1:5000';
    // Adigrat, Tigray, Ethiopia Bounding Box (for search bias)
    const ADIGRAT_VIEWBOX = '39.44,14.26,39.48,14.29'; 
    const ADIGRAT_CENTER = [14.275, 39.46];

    // --- Element Selectors ---
    const appContainer = document.getElementById('app-container');
    const steps = { 1: document.getElementById('step1'), 2: document.getElementById('step2') };
    const mapInstruction = document.getElementById('map-instruction');
    const forMyselfBtn = document.getElementById('for-myself-btn');
    const forSomeoneElseBtn = document.getElementById('for-someone-else-btn');
    const pickupContainer = document.getElementById('pickup-container');
    const locationStatus = document.getElementById('location-status');
    const destinationInput = document.getElementById('destination-input');
    const fareDisplay = document.getElementById('fare-display');
    const distanceDisplay = document.getElementById('distance-display');
    const phoneLabel = document.getElementById('phone-label');
    const phoneInput = document.getElementById('phone-input');
    const requestRideBtn = document.getElementById('request-ride-btn');
    const responseMessage = document.getElementById('response-message');
    const pickupSuggestions = document.getElementById('pickup-suggestions');
    const destinationSuggestions = document.getElementById('destination-suggestions');

    // --- State Variables ---
    let rideType = null;
    let userPickup = null;
    let userDestination = null;
    let rideDetails = null;
    let map;
    let pickupMarker, destinationMarker, routeLayer;
    let searchTimeout;

    // --- Initial Setup ---
    window.onload = () => {
        initLeafletMap();
    };

    // --- UI Navigation ---
    function goToStep(stepNumber) {
        Object.values(steps).forEach(step => step.classList.add('hidden'));
        steps[stepNumber].classList.remove('hidden');
        mapInstruction.classList.add('hidden'); // Hide instruction by default
    }
    
    // --- Event Handlers ---
    forMyselfBtn.addEventListener('click', () => setupStep2('myself'));
    forSomeoneElseBtn.addEventListener('click', () => setupStep2('someoneElse'));
    appContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('back-btn')) {
            goToStep(1);
            resetStep2();
            if (pickupMarker) map.removeLayer(pickupMarker);
            if (destinationMarker) map.removeLayer(destinationMarker);
            if (routeLayer) map.removeLayer(routeLayer);
            map.setView(ADIGRAT_CENTER, 15);
        }
    });
    requestRideBtn.addEventListener('click', handleRideRequest);
    
    // --- Core Logic ---
    function setupStep2(type) {
        rideType = type;
        resetStep2();
        
        updateMapInstruction();

        const supportsGeolocation = navigator.geolocation;
        if (type === 'myself') {
            const findMeButtonHTML = supportsGeolocation ? 
                `<button id="get-location-btn" class="relative inline-flex items-center space-x-2 px-4 py-2 border border-gray-300 text-sm font-medium rounded-l-md text-gray-700 bg-gray-50 hover:bg-gray-100">Find Me</button>` : '';
            pickupContainer.innerHTML = `
                ${findMeButtonHTML}
                <input type="text" id="pickup-input" class="flex-1 block w-full ${supportsGeolocation ? 'rounded-none rounded-r-md' : 'rounded-md'} sm:text-sm border-gray-300" placeholder="Enter pickup location">`;
            
            if(supportsGeolocation) document.getElementById('get-location-btn').addEventListener('click', getUserLocation);
            phoneLabel.textContent = "Your Phone Number";
        } else {
            pickupContainer.innerHTML = `<input type="text" id="pickup-input" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter pickup address">`;
            phoneLabel.textContent = "Passenger's Phone Number";
        }
        
        const pickupInput = document.getElementById('pickup-input');
        setupAutocomplete(pickupInput, pickupSuggestions, (place) => {
            userPickup = { lat: parseFloat(place.lat), lon: parseFloat(place.lon), address: place.display_name };
            updateMapAndFare();
        });
        setupAutocomplete(destinationInput, destinationSuggestions, (place) => {
            userDestination = { lat: parseFloat(place.lat), lon: parseFloat(place.lon), address: place.display_name };
            updateMapAndFare();
        });

        goToStep(2);
    }

    function initLeafletMap() {
        if (map) map.remove();
        map = L.map('map').setView(ADIGRAT_CENTER, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        map.on('click', handleMapClick);
    }

    function handleMapClick(e) {
        if (steps[2].classList.contains('hidden')) return;
        
        const { lat, lng } = e.latlng;
        
        // Determine if we're setting pickup or destination
        const isSettingPickup = !userPickup;
        const statusElement = isSettingPickup ? document.getElementById('pickup-input') : destinationInput;
        const statusMessage = isSettingPickup ? 'Pickup location set from map!' : 'Destination set from map!';
        
        setStatus('Fetching address...', 'blue');
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.display_name) {
                    const location = { lat: lat, lon: lng, address: data.display_name };
                    statusElement.value = location.address;
                    if (isSettingPickup) {
                        userPickup = location;
                    } else {
                        userDestination = location;
                    }
                    setStatus(statusMessage, 'green');
                    updateMapAndFare();
                } else {
                    setStatus('Could not find an address for this location.', 'red');
                }
            }).catch(() => setStatus('Failed to fetch address.', 'red'));
    }
    
    function setupAutocomplete(inputElement, suggestionsElement, callback) {
        inputElement.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = inputElement.value;
            if (query.length < 1) { 
                suggestionsElement.innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(async () => {
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&viewbox=${ADIGRAT_VIEWBOX}&bounded=1&countrycodes=et`;
                try {
                    const response = await fetch(url);
                    const results = await response.json();
                    suggestionsElement.innerHTML = '';
                    results.slice(0, 5).forEach(place => {
                        const div = document.createElement('div');
                        div.innerHTML = place.display_name;
                        div.className = 'autocomplete-suggestion';
                        div.onclick = () => {
                            inputElement.value = place.display_name;
                            suggestionsElement.innerHTML = '';
                            callback(place);
                        };
                        suggestionsElement.appendChild(div);
                    });
                } catch (error) {
                    console.error("Autocomplete error:", error);
                }
            }, 150);
        });
        document.addEventListener('click', (e) => {
             if (e.target !== inputElement) suggestionsElement.innerHTML = '';
        });
        inputElement.addEventListener('input', () => showMessage('', 'red'));
    }

    function getUserLocation() {
        // ... (This function remains largely the same)
        setStatus('Finding your location...', 'blue');
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                    .then(res => res.json())
                    .then(data => {
                        const lon = parseFloat(data.lon);
                        const lat = parseFloat(data.lat);
                        const viewBox = ADIGRAT_VIEWBOX.split(',');
                        if (lon >= parseFloat(viewBox[0]) && lon <= parseFloat(viewBox[2]) && lat >= parseFloat(viewBox[1]) && lat <= parseFloat(viewBox[3])) {
                            userPickup = { lat: latitude, lon: longitude, address: data.display_name || "Current Location" };
                            document.getElementById('pickup-input').value = userPickup.address;
                            setStatus('Location found!', 'green');
                            updateMapAndFare();
                        } else {
                            setStatus('Service is only available in Adigrat.', 'red');
                            userPickup = null;
                        }
                    });
            },
            () => setStatus('Please enable location services.', 'red')
        );
    }

    function updateMapAndFare() {
        if(pickupMarker) map.removeLayer(pickupMarker);
        if(destinationMarker) map.removeLayer(destinationMarker);
        if(routeLayer) map.removeLayer(routeLayer);

        if(userPickup) {
             pickupMarker = L.marker([userPickup.lat, userPickup.lon]).addTo(map).bindPopup('Pickup').openPopup();
        }
        if(userDestination) {
             destinationMarker = L.marker([userDestination.lat, userDestination.lon]).addTo(map).bindPopup('Destination');
        }

        if(userPickup && userDestination) {
            drawRouteOnMap(userPickup, userDestination);
            calculateFare();
        } else if (userPickup) {
             map.setView([userPickup.lat, userPickup.lon], 16);
        }
        updateMapInstruction();
    }
    
    function updateMapInstruction() {
        if(steps[2].classList.contains('hidden')) {
            mapInstruction.classList.add('hidden');
            return;
        }

        mapInstruction.classList.remove('hidden');
        if (!userPickup) {
            mapInstruction.textContent = 'Click on the map to set your pickup location.';
        } else if (!userDestination) {
            mapInstruction.textContent = 'Now, click on the map to set your destination.';
        } else {
            mapInstruction.classList.add('hidden');
        }
    }

    async function drawRouteOnMap(pickup, destination) {
        // ... (This function remains the same)
        const url = `https://router.project-osrm.org/route/v1/driving/${pickup.lon},${pickup.lat};${destination.lon},${destination.lat}?overview=full&geometries=geojson`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (data.routes && data.routes.length > 0) {
                const routeGeoJSON = data.routes[0].geometry;
                routeLayer = L.geoJSON(routeGeoJSON, {
                    style: { color: '#22c55e', weight: 5 }
                }).addTo(map);
                map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
            }
        } catch (error) {
            console.error('Error fetching route:', error);
        }
    }

    async function calculateFare() {
        // ... (This function remains the same)
        fareDisplay.textContent = "...";
        distanceDisplay.textContent = "...";
        try {
            const response = await fetch(`${API_BASE_URL}/api/fare-estimate`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pickup_lat: userPickup.lat, pickup_lon: userPickup.lon,
                    dest_lat: userDestination.lat, dest_lon: userDestination.lon
                })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Could not calculate fare.');
            rideDetails = data;
            fareDisplay.textContent = rideDetails.estimated_fare;
            distanceDisplay.textContent = rideDetails.distance_km;
        } catch (error) {
            setStatus(error.message, 'red');
        }
    }

    async function handleRideRequest() {
        // ... (This function remains the same)
        if (!userPickup) return showMessage('Please select a pickup location.', 'red');
        if (!userDestination) return showMessage('Please select a destination.', 'red');
        const phone = phoneInput.value.trim();
        if (!phone || phone.length < 9) return showMessage('Please enter a valid phone number.', 'red');
        const rideData = {
            phone_number: `+251${phone}`, pickup_lat: userPickup.lat, pickup_lon: userPickup.lon,
            dest_address: userDestination.address, distance_km: rideDetails.distance_km, fare: rideDetails.estimated_fare
        };
        try {
            showMessage('Sending your request...', 'blue');
            requestRideBtn.disabled = true;
            const response = await fetch(`${API_BASE_URL}/api/ride-request`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(rideData),
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'An unknown error occurred.');
            appContainer.innerHTML = `<div class="text-center py-8"><div class="mx-auto bg-green-100 text-green-600 w-16 h-16 rounded-full flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div><h2 class="text-xl font-bold text-gray-800 mt-4">Request Sent!</h2><p class="text-gray-600 mt-2">Your request has been received. The dispatcher will be in contact shortly.</p></div>`;
        } catch (error) {
            showMessage(`Error: ${error.message}.`, 'red');
            requestRideBtn.disabled = false;
        }
    }

    // --- Helper Functions ---
    function setStatus(message, color) { locationStatus.textContent = message; locationStatus.className = `text-xs text-${color}-500 mt-1`; }
    function showMessage(message, color) { responseMessage.textContent = message; responseMessage.className = `text-center mt-4 text-sm font-medium text-${color}-600`; }
    function resetStep2() {
        userPickup = null; userDestination = null; destinationInput.value = ''; phoneInput.value = '';
        locationStatus.textContent = ''; pickupContainer.innerHTML = ''; responseMessage.textContent = '';
        fareDisplay.textContent = '--'; distanceDisplay.textContent = '--';
    }
</script>
{% endblock %}

